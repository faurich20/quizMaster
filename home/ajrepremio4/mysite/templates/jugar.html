<!-- templates/jugar.html - VERSI√ìN CON TEMPORIZADOR SINCRONIZADO -->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugar - QuizPlatform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .barra-navegacion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .barra-navegacion.mostrar {
            display: flex;
        }

        .barra-navegacion h1 {
            font-size: 1.8em;
        }

        .derecha-navegacion {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn-navegacion {
            background: white;
            color: #667eea;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .btn-navegacion:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .contenido-pagina {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .barra-navegacion.mostrar+.contenido-pagina {
            min-height: calc(100vh - 60px);
        }

        .contenedor-juego {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            text-align: center;
        }

        .encabezado-juego {
            margin-bottom: 30px;
        }

        .encabezado-juego h1 {
            color: #333;
            font-size: 3em;
            margin-bottom: 10px;
        }

        .encabezado-juego p {
            color: #666;
            font-size: 1.1em;
        }

        .grupo-formulario {
            margin-bottom: 20px;
            text-align: left;
        }

        .grupo-formulario label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .grupo-formulario input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.2em;
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            transition: border-color 0.3s ease;
        }

        .grupo-formulario input:focus {
            outline: none;
            border-color: #667eea;
        }

        .grupo-formulario input::placeholder {
            letter-spacing: normal;
            font-weight: normal;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alerta {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alerta.mostrar {
            display: block;
        }

        .alerta-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .contenedor-enlaces {
            margin-top: 20px;
        }

        .contenedor-enlaces a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .contenedor-enlaces a:hover {
            text-decoration: underline;
        }

        .btn-secundario {
            width: 100%;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 15px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-secundario:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        #btnVolverInicio,
        #btnVolverInicioJuego,
        #btnVolverInicioResultados {
            display: none;
        }

        #btnVolverInicio.mostrar,
        #btnVolverInicioJuego.mostrar,
        #btnVolverInicioResultados.mostrar {
            display: inline-block;
        }

        .pantalla-juego {
            display: none;
        }

        .pantalla-juego.activa {
            display: block;
        }

        .contenedor-pregunta {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        /* ‚úÖ NUEVO: Mostrar tiempo en formato num√©rico grande */
        .display-tiempo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .display-tiempo .tiempo-numero {
            font-size: 3em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
        }

        .display-tiempo .tiempo-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .display-tiempo.critico {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .numero-pregunta {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .texto-pregunta {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .media-pregunta img {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .cuadricula-respuestas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .btn-respuesta {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1em;
            font-weight: 500;
        }

        .btn-respuesta:hover {
            transform: scale(1.05);
            border-color: #667eea;
            background: #f0f4ff;
        }

        .btn-respuesta.seleccionada {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .btn-respuesta.correcta {
            border-color: #4caf50;
            background: #4caf50;
            color: white;
        }

        .btn-respuesta.incorrecta {
            border-color: #f44336;
            background: #f44336;
            color: white;
        }

        .btn-respuesta:disabled {
            cursor: not-allowed;
        }

        .letra-respuesta {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .btn-respuesta.seleccionada .letra-respuesta,
        .btn-respuesta.correcta .letra-respuesta {
            background: rgba(255, 255, 255, 0.3);
        }

        .texto-respuesta {
            flex: 1;
            text-align: left;
        }

        .pantalla-resultados {
            display: none;
            text-align: center;
        }

        .pantalla-resultados.activa {
            display: block;
        }

        .encabezado-resultados {
            margin-bottom: 30px;
        }

        .encabezado-resultados h2 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .mostrar-puntuacion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .mostrar-puntuacion h3 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .mostrar-puntuacion p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .lista-clasificacion {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .item-clasificacion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .item-clasificacion:last-child {
            margin-bottom: 0;
        }

        .posicion-clasificacion {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .posicion-clasificacion.primero {
            background: #ffd700;
            color: #333;
        }

        .posicion-clasificacion.segundo {
            background: #c0c0c0;
            color: #333;
        }

        .posicion-clasificacion.tercero {
            background: #cd7f32;
            color: white;
        }

        .nombre-clasificacion {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-weight: 500;
        }

        .puntuacion-clasificacion {
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .cuadricula-respuestas {
                grid-template-columns: 1fr;
            }

            .display-tiempo .tiempo-numero {
                font-size: 2.5em;
            }
        }
    </style>
</head>

<body>
    <div class="barra-navegacion" id="barraNavegacion">
        <h1>üéØ QuizPlatform</h1>
        <div class="derecha-navegacion">
            <span>Bienvenido, <strong id="nombreUsuarioNav"></strong></span>
            <a href="/cerrar_sesion" class="btn-navegacion">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="contenido-pagina">
        <div class="contenedor-juego">
            <div id="pantallaUnirse" class="pantalla-unirse activa">
                <div class="encabezado-juego">
                    <h1>üéÆ</h1>
                    <h1>QuizPlatform</h1>
                    <p>√önete a la partida</p>
                </div>
                <div class="alerta alerta-error" id="alertaError"></div>
                <form id="formularioUnirse">
                    <div class="grupo-formulario">
                        <label for="codigoPin">C√≥digo PIN:</label>
                        <input type="text" id="codigoPin" placeholder="Ingresa el PIN" required maxlength="8" autofocus>
                    </div>
                    <div class="grupo-formulario" id="grupoUsuario">
                        <label for="nombreUsuario">Tu nombre:</label>
                        <input type="text" id="nombreUsuario" placeholder="Ingresa tu nombre">
                    </div>
                    <button type="submit" class="btn">Unirse al Juego</button>
                </form>
                <a href="/" class="btn-secundario" id="btnVolverInicio">‚Üê Volver a Inicio</a>
            </div>

            <div id="pantallaJuego" class="pantalla-juego">
                <div class="contenedor-pregunta">
                    <!-- ‚úÖ NUEVO: Display de tiempo num√©rico -->
                    <div class="display-tiempo" id="displayTiempo">
                        <div class="tiempo-numero" id="tiempoNumero">00:00</div>
                        <div class="tiempo-label">Tiempo restante</div>
                    </div>

                    <div class="numero-pregunta" id="numeroPregunta">Pregunta 1 de 10</div>
                    <div class="texto-pregunta" id="textoPregunta"></div>
                    <p id="tiempoPregunta" style="font-size: 22px; font-weight: 600; margin-top: 4px;">
                        ‚è± Tiempo pregunta: --</p>
                    <div class="media-pregunta" id="mediaPregunta"></div>
                </div>
                <div class="cuadricula-respuestas" id="cuadriculaRespuestas"></div>
                <a href="/" class="btn-secundario" id="btnVolverInicioJuego">‚Üê Volver a Inicio</a>
            </div>

            <div id="pantallaResultados" class="pantalla-resultados">
                <div class="encabezado-resultados">
                    <h2>üéâ ¬°Juego Terminado!</h2>
                </div>
                <div class="mostrar-puntuacion">
                    <h3 id="puntuacionFinal">0</h3>
                    <p>Puntos Totales</p>
                </div>
                <div class="lista-clasificacion">
                    <h3 style="margin-bottom: 15px; color: #333;">üèÜ Ranking Final</h3>
                    <div id="listaClasificacion"></div>
                </div>
                <a href="/" class="btn-secundario" id="btnVolverInicioResultados" style="margin-top: 15px;">‚Üê Volver a
                    Inicio</a>
            </div>
        </div>
    </div>

    <script>
        let preguntaActual = 0;
        let preguntas = [];
        let idParticipante = null;
        let idSesion = null;
        let puntuacion = 0;
        let intervaloTemporizador = null;
        let nombreUsuarioLogueado = null;
        let intervaloVerificacionSesion = null;
        let tiempoInicioPregunta = null;

        // ‚úÖ NUEVO: Variables para sincronizaci√≥n con servidor
        let expiraTemporizadorQuiz = null; // Timestamp de expiraci√≥n del quiz completo
        let tiemposAcumuladosPreguntas = []; // Array con tiempo acumulado hasta cada pregunta

        const parametrosURL = new URLSearchParams(window.location.search);
        const inicioAutomatico = parametrosURL.get('inicio_automatico');
        const idSesionURL = parametrosURL.get('id_sesion');
        const idParticipanteURL = parametrosURL.get('id_participante');

        if (inicioAutomatico === 'true' && idSesionURL && idParticipanteURL) {
            idSesion = idSesionURL;
            idParticipante = idParticipanteURL;
            const elementoUnirse = document.getElementById('pantallaUnirse');
            if (elementoUnirse) {
                elementoUnirse.style.display = 'none';
                elementoUnirse.classList.remove('activa');
            }
            fetch(`/api/sesion/${idSesion}/info`)
                .then(respuesta => respuesta.json())
                .then(datos => {
                    // ‚úÖ Guardar expira_temporizador
                    if (datos.expira_temporizador) {
                        try {
                            const expiraStr = datos.expira_temporizador.replace(' ', 'T');
                            const expiraDate = new Date(expiraStr);
                            if (!isNaN(expiraDate.getTime())) {
                                expiraTemporizadorQuiz = expiraDate.getTime();
                                console.log('‚úÖ Expiraci√≥n quiz:', new Date(expiraTemporizadorQuiz).toLocaleString());
                            }
                        } catch (e) {
                            console.error('Error procesando expira_temporizador:', e);
                        }
                    }

                    cargarPreguntas(datos.quiz.id).then(() => {
                        verificarProgreso();
                    });
                })
                .catch(error => {
                    alert('Error cargando el quiz');
                    window.location.href = '/';
                });
        }

        async function verificarProgreso() {
            if (!idParticipante) return;


            try {
                const respuesta = await fetch(`/api/participante/${idParticipante}/progreso`);
                const progreso = await respuesta.json();

                if (progreso.id_ultima_pregunta && preguntas.length > 0) {

                    // ‚úÖ Recuperar puntuaci√≥n guardada
                    puntuacion = progreso.puntuacion_total || 0;
                    console.log("‚úÖ Puntuaci√≥n restaurada:", puntuacion);

                    const ultimoIndice = preguntas.findIndex(p => p.id === progreso.id_ultima_pregunta);

                    if (ultimoIndice >= 0 && ultimoIndice < preguntas.length - 1) {
                        preguntaActual = ultimoIndice + 1;
                        puntuacion = progreso.puntuacion_total || 0;
                        document.getElementById('pantallaJuego').classList.add('activa');
                        mostrarPregunta(preguntaActual);
                        iniciarVerificacionSesion();

                    } else if (ultimoIndice === preguntas.length - 1) {
                        puntuacion = progreso.puntuacion_total || 0;
                        mostrarResultados();
                    } else {
                        document.getElementById('pantallaJuego').classList.add('activa');

                        if (datos.estado !== 'iniciada') {
                            window.location.href = `/sala_espera?id_sesion=${idSesion}&id_participante=${idParticipante}`;
                            return;
                        }
                        mostrarPregunta(0);
                        iniciarVerificacionSesion();
                    }
                } else {
                    document.getElementById('pantallaJuego').classList.add('activa');
                    mostrarPregunta(0);
                    iniciarVerificacionSesion();
                }
            } catch (error) {
                console.error('Error verificando progreso:', error);
                document.getElementById('pantallaJuego').classList.add('activa');
                mostrarPregunta(0);
                iniciarVerificacionSesion();
            }
        }

        function iniciarVerificacionSesion() {
            if (!idSesion) return;

            intervaloVerificacionSesion = setInterval(async () => {
                try {
                    const respuesta = await fetch(`/api/sesion/${idSesion}/verificar_estado`);
                    const datos = await respuesta.json();

                    if (!datos.activa || datos.estado === 'finalizada') {
                        clearInterval(intervaloVerificacionSesion);
                        if (intervaloTemporizador) clearInterval(intervaloTemporizador);
                        mostrarResultados();
                        alert('Tiempo agotado o cancelado. Juego finalizado.');
                    }
                } catch (error) {
                    console.error('Error verificando sesi√≥n:', error);
                }
            }, 2000);
        }

        window.addEventListener('beforeunload', () => {
            if (intervaloVerificacionSesion) clearInterval(intervaloVerificacionSesion);
            if (intervaloTemporizador) clearInterval(intervaloTemporizador);
        });

        function inicializarInterfazUsuario() {
            fetch('/api/info_sesion')
                .then(respuesta => respuesta.json())
                .then(datos => {
                    if (datos.nombre_usuario && !datos.es_profesor) {
                        nombreUsuarioLogueado = datos.nombre_usuario;
                        document.getElementById('nombreUsuarioNav').textContent = datos.nombre_usuario;
                        document.getElementById('barraNavegacion').classList.add('mostrar');
                        const botonesVolver = ['btnVolverInicio', 'btnVolverInicioJuego', 'btnVolverInicioResultados'];
                        botonesVolver.forEach(id => {
                            const elemento = document.getElementById(id);
                            if (elemento) elemento.classList.remove('mostrar');
                        });
                        const grupo = document.getElementById('grupoUsuario');
                        if (grupo) grupo.style.display = 'none';
                        const entradaUsuario = document.getElementById('nombreUsuario');
                        if (entradaUsuario) entradaUsuario.value = datos.nombre_usuario;
                    } else if (datos.nombre_usuario && datos.es_profesor) {
                        window.location.href = '/panel_control';
                    } else {
                        ['btnVolverInicio', 'btnVolverInicioJuego', 'btnVolverInicioResultados'].forEach(id => {
                            const elemento = document.getElementById(id);
                            if (elemento) elemento.classList.add('mostrar');
                        });
                        const entradaUsuario = document.getElementById('nombreUsuario');
                        if (entradaUsuario) entradaUsuario.required = true;
                    }
                })
                .catch(error => {
                    ['btnVolverInicio', 'btnVolverInicioJuego', 'btnVolverInicioResultados'].forEach(id => {
                        const elemento = document.getElementById(id);
                        if (elemento) elemento.classList.add('mostrar');
                    });
                    const entradaUsuario = document.getElementById('nombreUsuario');
                    if (entradaUsuario) entradaUsuario.required = true;
                });
        }

        inicializarInterfazUsuario();

        if (!(inicioAutomatico === 'true' && idSesionURL && idParticipanteURL)) {
            document.getElementById('formularioUnirse').addEventListener('submit', async function (e) {
                e.preventDefault();
                const codigoPin = document.getElementById('codigoPin').value.toUpperCase();
                const nombreUsuario = document.getElementById('nombreUsuario').value || nombreUsuarioLogueado;

                if (!nombreUsuario) {
                    mostrarAlerta('Por favor ingresa tu nombre');
                    return;
                }

                try {
                    const respuesta = await fetch('/api/unirse_juego', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ codigo_pin: codigoPin, nombre_usuario: nombreUsuario })
                    });
                    const datos = await respuesta.json();
                    if (respuesta.ok) {
                        idParticipante = datos.id_participante;
                        idSesion = datos.id_sesion;

                        if (!idSesion || !idParticipante) {
                            alert('No se pudo unir a la sesi√≥n; faltan par√°metros.');
                            return;
                        }

                        // ‚úÖ Guardar expira_temporizador si est√° disponible
                        if (datos.expira_temporizador) {
                            try {
                                const expiraStr = datos.expira_temporizador.replace(' ', 'T');
                                const expiraDate = new Date(expiraStr);
                                if (!isNaN(expiraDate.getTime())) {
                                    expiraTemporizadorQuiz = expiraDate.getTime();
                                }
                            } catch (e) {
                                console.error('Error procesando expira_temporizador:', e);
                            }
                        }

                        if (datos.quiz.modo === 'grupal') {
                            window.location.href = `/seleccion_grupo?id_sesion=${idSesion}&id_participante=${idParticipante}`;
                            return;
                        }

                        await cargarPreguntas(datos.quiz.id);
                        document.getElementById('pantallaUnirse').classList.remove('activa');
                        document.getElementById('pantallaJuego').classList.add('activa');
                        mostrarPregunta(0);
                        iniciarVerificacionSesion();
                    } else {
                        mostrarAlerta(datos.error || 'Error al unirse al juego');
                    }
                } catch (error) {
                    mostrarAlerta('Error de conexi√≥n');
                }
            });
        }

        async function cargarPreguntas(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                preguntas = quiz.preguntas || [];

                // ‚úÖ Calcular tiempos acumulados para cada pregunta
                calcularTiemposAcumulados();
            } catch (error) {
                console.error('Error cargando preguntas:', error);
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Calcular tiempos acumulados
        function calcularTiemposAcumulados() {
            tiemposAcumuladosPreguntas = [];
            let acumulado = 0;
            preguntas.forEach(pregunta => {
                tiemposAcumuladosPreguntas.push(acumulado);
                acumulado += parseInt(pregunta.tiempo_limite) || 30;
            });
        }

        // ‚úÖ NUEVA FUNCI√ìN: Calcular tiempo restante sincronizado
        function calcularTiempoRestante(indicePregunta) {
            if (!expiraTemporizadorQuiz || !tiemposAcumuladosPreguntas.length) {
                // Fallback: usar tiempo_limite de la pregunta
                const pregunta = preguntas[indicePregunta];
                return parseInt(pregunta?.tiempo_limite) || 30;
            }

            const ahora = Date.now();
            const tiempoRestanteTotal = Math.max(0, Math.floor((expiraTemporizadorQuiz - ahora) / 1000));

            // Calcular tiempo transcurrido desde el inicio del quiz
            const tiempoTotalQuiz = tiemposAcumuladosPreguntas[tiemposAcumuladosPreguntas.length - 1] +
                (parseInt(preguntas[preguntas.length - 1]?.tiempo_limite) || 30);
            const tiempoTranscurrido = tiempoTotalQuiz - tiempoRestanteTotal;

            // Calcular tiempo restante para esta pregunta espec√≠fica
            const tiempoInicioPregunta = tiemposAcumuladosPreguntas[indicePregunta];
            const tiempoLimitePregunta = parseInt(preguntas[indicePregunta]?.tiempo_limite) || 30;
            const tiempoTranscurridoEnPregunta = Math.max(0, tiempoTranscurrido - tiempoInicioPregunta);

            return Math.max(0, tiempoLimitePregunta - tiempoTranscurridoEnPregunta);
        }

        async function mostrarPregunta(indice) {
            if (indice >= preguntas.length) {
                return mostrarResultados();
            }

            preguntaActual = indice;
            const pregunta = preguntas[indice];

            // 1) Abrir/recuperar T2 en servidor
            let expiraT2 = null;
            try {
                // Primero intentamos leer si existe
                const check = await fetch(`/api/pregunta/${pregunta.id}/tiempo?participante_id=${idParticipante}&sesion_id=${idSesion}`);
                const existe = await check.json();

                if (existe && existe.existe) {
                    expiraT2 = new Date(existe.expira_en.replace(' ', 'T')).getTime();
                } else {
                    // Si no existe, lo creamos ahora mismo
                    const resp = await fetch(`/api/pregunta/${pregunta.id}/abrir`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_participante: idParticipante, id_sesion: idSesion })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'No se pudo abrir la pregunta');
                    expiraT2 = new Date(data.expira_en.replace(' ', 'T')).getTime();
                }
            } catch (e) {
                console.error(e);
                alert('No se pudo sincronizar el tiempo de esta pregunta.');
                return mostrarResultados();
            }

            // 2) Pintar en la UI
            document.getElementById('numeroPregunta').textContent =
                `Pregunta ${indice + 1} de ${preguntas.length}  ‚Äî  ${pregunta.tiempo_limite || 30}s`;
            document.getElementById('textoPregunta').textContent = pregunta.texto_pregunta || '';
            const media = document.getElementById('mediaPregunta');
            media.innerHTML = '';
            if (pregunta.url_imagen) media.innerHTML += `<img src="${pregunta.url_imagen}" alt="" style="max-width:100%;border-radius:12px;margin:10px 0;">`;
            if (pregunta.url_video) media.innerHTML += `<p>üìπ <a href="${pregunta.url_video}" target="_blank">Ver video</a></p>`;

            const cont = document.getElementById('cuadriculaRespuestas');
            cont.innerHTML = (pregunta.opciones || []).map((op, i) => `
        <button class="btn-respuesta" onclick="seleccionarRespuesta(${i}, ${pregunta.id}, ${op.id})">${op.texto_opcion}</button>
    `).join('');

            // 3) Iniciar temporizador usando expiraT2 y capar por T1 si aplica
            if (intervaloTemporizador) clearInterval(intervaloTemporizador);
            tiempoInicioPregunta = Date.now();

            function tick() {
                const ahora = Date.now();

                // ‚è± Tiempo por pregunta (T2)
                const secsPregunta = Math.max(0, Math.floor((expiraT2 - ahora) / 1000));

                // ‚è≤Ô∏è Tiempo global del quiz (T1), si existe
                let secsQuiz = null;
                if (expiraTemporizadorQuiz) {
                    secsQuiz = Math.max(0, Math.floor((expiraTemporizadorQuiz - ahora) / 1000));
                }

                // ---- Pintar TIEMPO POR PREGUNTA (‚è±) ----
                const mmP = String(Math.floor(secsPregunta / 60)).padStart(2, '0');
                const ssP = String(secsPregunta % 60).padStart(2, '0');
                const tiempoPreguntaEl = document.getElementById('tiempoPregunta');
                if (tiempoPreguntaEl) {
                    tiempoPreguntaEl.textContent = `‚è± Tiempo pregunta: ${mmP}:${ssP}`;
                }

                // ---- Pintar TIEMPO GLOBAL ARRIBA ----
                // Si hay T1, se muestra T1; si no, se usa el de pregunta como fallback
                const secsDisplay = (secsQuiz !== null) ? secsQuiz : secsPregunta;
                const mmQ = String(Math.floor(secsDisplay / 60)).padStart(2, '0');
                const ssQ = String(secsDisplay % 60).padStart(2, '0');
                const display = document.getElementById('tiempoNumero');
                const caja = document.getElementById('displayTiempo');
                if (display) display.textContent = `${mmQ}:${ssQ}`;
                if (caja) {
                    const crit = (secsQuiz !== null ? secsQuiz : secsPregunta) <= 10;
                    caja.classList.toggle('critico', crit);
                }

                // ---- Cortes autoritativos ----
                // Si se acab√≥ el QUIZ (T1) -> terminar juego
                if (secsQuiz !== null && secsQuiz <= 0) {
                    clearInterval(intervaloTemporizador);
                    mostrarResultados();
                    return;
                }
                // Si se acab√≥ la PREGUNTA (T2) -> pasar a la siguiente
                if (secsPregunta <= 0) {
                    clearInterval(intervaloTemporizador);
                    mostrarPregunta(indice + 1);
                    return;
                }
            }


            tick();
            intervaloTemporizador = setInterval(tick, 1000);
        }


        // ‚úÖ NUEVA FUNCI√ìN: Temporizador sincronizado con servidor
        function iniciarTemporizadorSincronizado(indicePregunta) {
            if (intervaloTemporizador) {
                clearInterval(intervaloTemporizador);
                intervaloTemporizador = null;
            }

            tiempoInicioPregunta = Date.now();
            const displayTiempo = document.getElementById('displayTiempo');
            const tiempoNumero = document.getElementById('tiempoNumero');

            // Calcular tiempo restante inicial
            let tiempoRestante = calcularTiempoRestante(indicePregunta);

            // Actualizar display inmediatamente
            actualizarDisplayTiempo(tiempoRestante);

            // Actualizar cada segundo
            intervaloTemporizador = setInterval(() => {
                tiempoRestante = calcularTiempoRestante(indicePregunta);
                actualizarDisplayTiempo(tiempoRestante);

                // Si el tiempo se agot√≥, avanzar a la siguiente pregunta
                if (tiempoRestante <= 0) {
                    clearInterval(intervaloTemporizador);
                    intervaloTemporizador = null;
                    setTimeout(() => {
                        mostrarPregunta(preguntaActual + 1);
                    }, 1000);
                }
            }, 1000);
        }

        // ‚úÖ NUEVA FUNCI√ìN: Actualizar display de tiempo
        function actualizarDisplayTiempo(segundos) {
            const minutos = Math.floor(segundos / 60);
            const segs = segundos % 60;
            const displayTiempo = document.getElementById('displayTiempo');
            const tiempoNumero = document.getElementById('tiempoNumero');

            tiempoNumero.textContent = `${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;

            // Cambiar color cuando quedan menos de 10 segundos
            if (segundos <= 10) {
                displayTiempo.classList.add('critico');
            } else {
                displayTiempo.classList.remove('critico');
            }
        }

        async function seleccionarRespuesta(indiceOpcion, idPregunta, idOpcion) {
            console.log("======== RESPUESTA SELECCIONADA ========");
            console.log("id_pregunta:", idPregunta);
            console.log("id_opcion:", idOpcion);
            console.log("participante:", idParticipante, "sesion:", idSesion);
            console.log("TiempoInicioPregunta:", tiempoInicioPregunta, "Ahora:", Date.now());

            if (intervaloTemporizador) {
                clearInterval(intervaloTemporizador);
                intervaloTemporizador = null;
            }

            const pregunta = preguntas[preguntaActual];
            const opcionSeleccionada = pregunta.opciones[indiceOpcion];
            const esCorrecta = opcionSeleccionada.es_correcta;

            // Calcular tiempo utilizado
            const tiempoTranscurrido = (Date.now() - tiempoInicioPregunta) / 1000;
            console.log("Tiempo transcurrido:", tiempoTranscurrido.toFixed(3), "seg");
            console.log("Correcta:", esCorrecta);
            const tiempoUtilizado = Math.min(tiempoTranscurrido, pregunta.tiempo_limite);
            console.log("Tiempo utilizado:", tiempoUtilizado.toFixed(3), "seg");
            const puntos = esCorrecta ? Math.max(100, 1000 - (tiempoUtilizado * 10)) : 0;
            console.log("Puntos calculados:", puntos);
            
            // Mostrar feedback visual
            const botones = document.querySelectorAll('.btn-respuesta');
            botones.forEach((boton, i) => {
                boton.disabled = true;
                if (pregunta.opciones[i].es_correcta) {
                    boton.classList.add('correcta');
                } else if (i === indiceOpcion && !esCorrecta) {
                    boton.classList.add('incorrecta');
                }
            });

            // ‚úÖ Enviar al backend y SOLO sumar si fue aceptado
            let guardadoOK = false;

            try {
                const resp = await fetch('/api/guardar_respuesta', {                 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_participante: idParticipante,
                        id_pregunta: idPregunta,
                        id_opcion: idOpcion,
                        tiempo_respuesta: tiempoUtilizado,
                        puntos_ganados: puntos
                    }) 
                    
                    
                });
                console.log("üì§ Enviando al backend:", {
                    id_participante: idParticipante,
                    id_pregunta: idPregunta,
                    id_opcion: idOpcion,
                    tiempo_respuesta: tiempoUtilizado,
                    puntos_ganados: puntos
                });

                const data = await resp.json().catch(() => ({}));
                console.log("üì• Respuesta backend (status):", resp.status);
                console.log("üì• Respuesta backend (json):", data);


                guardadoOK = resp.ok && data && data.exito;

                if (!guardadoOK) {
                    console.warn('‚ùå Respuesta NO guardada en servidor:', data?.error);
                    alert('‚ö†Ô∏è Tu respuesta no se guard√≥ a tiempo o ya estaba respondida.');
                }
            } catch (error) {
                console.error('Error guardando respuesta:', error);
                alert('‚ö†Ô∏è Error de conexi√≥n al guardar. No se sumar√°n puntos.');
            }

            // ‚úÖ SOLO ahora sumamos puntos localmente si el servidor valid√≥
            if (guardadoOK && esCorrecta) {
                puntuacion += puntos;
            }

            // Notificar sincronizaci√≥n entre pesta√±as SOLO si el backend acept√≥
            if (guardadoOK) {
                localStorage.setItem(`resp_${idSesion}_${idParticipante}`, Date.now());
            }

            // Pasar a la siguiente pregunta despu√©s de 2s
            setTimeout(() => {
                mostrarPregunta(preguntaActual + 1);
            }, 2000);

            
        }



        async function mostrarResultados() {
            if (intervaloVerificacionSesion) clearInterval(intervaloVerificacionSesion);
            if (intervaloTemporizador) clearInterval(intervaloTemporizador);

            document.getElementById('pantallaJuego').classList.remove('activa');
            document.getElementById('pantallaResultados').classList.add('activa');

            // ‚úÖ Obtener la puntuaci√≥n REAL desde BD
            try {
                const progresoResp = await fetch(`/api/participante/${idParticipante}/progreso`);
                const progresoData = await progresoResp.json();

                puntuacion = progresoData.puntuacion_total || 0; // actualizar variable local
                document.getElementById('puntuacionFinal').textContent = Math.round(puntuacion);

            } catch (err) {
                console.error("Error obteniendo puntuaci√≥n final:", err);
                document.getElementById('puntuacionFinal').textContent = Math.round(puntuacion); // fallback
            }


            try {
                const respuesta = await fetch(`/api/resultados_juego/${idSesion}`);
                const clasificacion = await respuesta.json();
                const lista = document.getElementById('listaClasificacion');

                lista.innerHTML = clasificacion.map((participante, indice) => {
                    const clase = indice === 0 ? 'primero' : indice === 1 ? 'segundo' : indice === 2 ? 'tercero' : '';
                    const medalla = indice === 0 ? 'ü•á' : indice === 1 ? 'ü•à' : indice === 2 ? 'ü•â' : '';
                    return `<div class="item-clasificacion">
                        <div class="posicion-clasificacion ${clase}">${medalla || (indice + 1)}</div>
                        <div class="nombre-clasificacion">${participante.nombre_usuario}</div>
                        <div class="puntuacion-clasificacion">${participante.puntuacion_total} pts</div>
                    </div>`;
                }).join('');

                const encabezadoResultados = document.querySelector('.encabezado-resultados');
                const botonAnteriorRepetir = document.getElementById('btnRepetir');
                const botonAnteriorSalir = document.getElementById('btnSalir');
                if (botonAnteriorRepetir) botonAnteriorRepetir.remove();
                if (botonAnteriorSalir) botonAnteriorSalir.remove();

                const respuestaSesion = await fetch(`/api/sesion/${idSesion}/info`);
                const informacionSesion = await respuestaSesion.json();
                const intentosRestantes = informacionSesion.intentos_restantes || 0;
                const idQuiz = informacionSesion.quiz?.id;

                if (intentosRestantes > 0) {
                    const btnRepetir = document.createElement('button');
                    btnRepetir.className = 'btn';
                    btnRepetir.id = 'btnRepetir';
                    btnRepetir.textContent = 'Jugar Otra Vez';
                    btnRepetir.style.marginTop = '12px';
                    btnRepetir.addEventListener('click', async function () {
                        try {
                            const respuestaConsumir = await fetch(`/api/sesion/${idSesion}/consumir_intento`, { method: 'POST' });
                            const datosConsumir = await respuestaConsumir.json();
                            if (respuestaConsumir.ok) {
                                alert(`Intento consumido. Intentos restantes: ${datosConsumir.intentos_restantes}`);
                                iniciarQuizDesdeCero(idQuiz);
                            } else {
                                alert('‚ùå ' + (datosConsumir.error || 'No se pudo consumir el intento'));
                            }
                        } catch (error) {
                            alert('Error de conexi√≥n al consumir intento');
                        }
                    });
                    encabezadoResultados.appendChild(btnRepetir);
                } else {
                    const btnSalir = document.createElement('button');
                    btnSalir.className = 'btn';
                    btnSalir.id = 'btnSalir';
                    btnSalir.textContent = 'Salir';
                    btnSalir.style.marginTop = '12px';
                    btnSalir.addEventListener('click', function () {
                        window.location.href = '/jugar';
                    });
                    encabezadoResultados.appendChild(btnSalir);
                }
            } catch (error) {
                console.error('Error al mostrar resultados:', error);
            }
        }

        async function iniciarQuizDesdeCero(idQuiz) {
            try {
                if (!preguntas || preguntas.length === 0) {
                    await cargarPreguntas(idQuiz);
                }

                if (!preguntas || preguntas.length === 0) {
                    alert('No se pudo cargar el quiz para reiniciar.');
                    window.location.href = '/jugar';
                    return;
                }

                preguntaActual = 0;
                puntuacion = 0;
                if (intervaloTemporizador) {
                    clearInterval(intervaloTemporizador);
                    intervaloTemporizador = null;
                }

                // ‚úÖ Recargar expira_temporizador actualizado
                const respuestaSesion = await fetch(`/api/sesion/${idSesion}/info`);
                const informacionSesion = await respuestaSesion.json();
                if (informacionSesion.expira_temporizador) {
                    try {
                        const expiraStr = informacionSesion.expira_temporizador.replace(' ', 'T');
                        const expiraDate = new Date(expiraStr);
                        if (!isNaN(expiraDate.getTime())) {
                            expiraTemporizadorQuiz = expiraDate.getTime();
                        }
                    } catch (e) {
                        console.error('Error procesando expira_temporizador:', e);
                    }
                }

                const elementoUnirse = document.getElementById('pantallaUnirse');
                if (elementoUnirse) {
                    elementoUnirse.style.display = 'none';
                    elementoUnirse.classList.remove('activa');
                }
                document.getElementById('pantallaResultados').classList.remove('activa');
                document.getElementById('pantallaJuego').classList.add('activa');

                mostrarPregunta(0);
                iniciarVerificacionSesion();
            } catch (error) {
                console.error('Error reiniciando quiz:', error);
                alert('Error reiniciando el quiz.');
                window.location.href = '/jugar';
            }
        }

        function mostrarAlerta(mensaje) {
            const elemento = document.getElementById('alertaError');
            elemento.textContent = mensaje;
            elemento.classList.add('mostrar');
            setTimeout(() => elemento.classList.remove('mostrar'), 5000);
        }

        // ‚úÖ SINCRONIZACI√ìN ENTRE PESTA√ëAS
        window.addEventListener('storage', (e) => {
            if (e.key === `resp_${idSesion}_${idParticipante}`) {

                // detener timer
                if (intervaloTemporizador) clearInterval(intervaloTemporizador);

                // avanzar a la siguiente pregunta inmediatamente
                mostrarPregunta(preguntaActual + 1);
            }
        });


    </script>

</body>

</html>