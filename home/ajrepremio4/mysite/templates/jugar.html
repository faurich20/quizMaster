<!-- templates/jugar.html -->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugar - QuizPlatform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .barra-navegacion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .barra-navegacion.mostrar {
            display: flex;
        }

        .barra-navegacion h1 {
            font-size: 1.8em;
        }

        .derecha-navegacion {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn-navegacion {
            background: white;
            color: #667eea;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .btn-navegacion:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .contenido-pagina {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .barra-navegacion.mostrar+.contenido-pagina {
            min-height: calc(100vh - 60px);
        }

        .contenedor-juego {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            text-align: center;
        }

        .encabezado-juego {
            margin-bottom: 30px;
        }

        .encabezado-juego h1 {
            color: #333;
            font-size: 3em;
            margin-bottom: 10px;
        }

        .encabezado-juego p {
            color: #666;
            font-size: 1.1em;
        }

        .grupo-formulario {
            margin-bottom: 20px;
            text-align: left;
        }

        .grupo-formulario label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .grupo-formulario input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.2em;
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            transition: border-color 0.3s ease;
        }

        .grupo-formulario input:focus {
            outline: none;
            border-color: #667eea;
        }

        .grupo-formulario input::placeholder {
            letter-spacing: normal;
            font-weight: normal;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alerta {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alerta.mostrar {
            display: block;
        }

        .alerta-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .contenedor-enlaces {
            margin-top: 20px;
        }

        .contenedor-enlaces a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .contenedor-enlaces a:hover {
            text-decoration: underline;
        }

        .btn-secundario {
            width: 100%;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 15px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-secundario:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        #btnVolverInicio,
        #btnVolverInicioJuego,
        #btnVolverInicioResultados {
            display: none;
        }

        #btnVolverInicio.mostrar,
        #btnVolverInicioJuego.mostrar,
        #btnVolverInicioResultados.mostrar {
            display: inline-block;
        }

        .pantalla-juego {
            display: none;
        }

        .pantalla-juego.activa {
            display: block;
        }

        .contenedor-pregunta {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .barra-tiempo {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .relleno-tiempo {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #ffc107, #f44336);
            transition: width 0.1s linear;
        }

        .numero-pregunta {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .texto-pregunta {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .media-pregunta img {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .cuadricula-respuestas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .btn-respuesta {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1em;
            font-weight: 500;
        }

        .btn-respuesta:hover {
            transform: scale(1.05);
            border-color: #667eea;
            background: #f0f4ff;
        }

        .btn-respuesta.seleccionada {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .btn-respuesta.correcta {
            border-color: #4caf50;
            background: #4caf50;
            color: white;
        }

        .btn-respuesta.incorrecta {
            border-color: #f44336;
            background: #f44336;
            color: white;
        }

        .btn-respuesta:disabled {
            cursor: not-allowed;
        }

        .letra-respuesta {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .btn-respuesta.seleccionada .letra-respuesta,
        .btn-respuesta.correcta .letra-respuesta {
            background: rgba(255, 255, 255, 0.3);
        }

        .texto-respuesta {
            flex: 1;
            text-align: left;
        }

        .pantalla-resultados {
            display: none;
            text-align: center;
        }

        .pantalla-resultados.activa {
            display: block;
        }

        .encabezado-resultados {
            margin-bottom: 30px;
        }

        .encabezado-resultados h2 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .mostrar-puntuacion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .mostrar-puntuacion h3 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .mostrar-puntuacion p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .lista-clasificacion {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .item-clasificacion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .item-clasificacion:last-child {
            margin-bottom: 0;
        }

        .posicion-clasificacion {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .posicion-clasificacion.primero {
            background: #ffd700;
            color: #333;
        }

        .posicion-clasificacion.segundo {
            background: #c0c0c0;
            color: #333;
        }

        .posicion-clasificacion.tercero {
            background: #cd7f32;
            color: white;
        }

        .nombre-clasificacion {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-weight: 500;
        }

        .puntuacion-clasificacion {
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .cuadricula-respuestas {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="barra-navegacion" id="barraNavegacion">
        <h1>üéØ QuizPlatform</h1>
        <div class="derecha-navegacion">
            <span>Bienvenido, <strong id="nombreUsuarioNav"></strong></span>
            <a href="/cerrar_sesion" class="btn-navegacion">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="contenido-pagina">
        <div class="contenedor-juego">
            <div id="pantallaUnirse" class="pantalla-unirse activa">
                <div class="encabezado-juego">
                    <h1>üéÆ</h1>
                    <h1>QuizPlatform</h1>
                    <p>√önete a la partida</p>
                </div>
                <div class="alerta alerta-error" id="alertaError"></div>
                <form id="formularioUnirse">
                    <div class="grupo-formulario">
                        <label for="codigoPin">C√≥digo PIN:</label>
                        <input type="text" id="codigoPin" placeholder="Ingresa el PIN" required maxlength="8" autofocus>
                    </div>
                    <div class="grupo-formulario" id="grupoUsuario">
                        <label for="nombreUsuario">Tu nombre:</label>
                        <input type="text" id="nombreUsuario" placeholder="Ingresa tu nombre">
                    </div>
                    <button type="submit" class="btn">Unirse al Juego</button>
                </form>
                <a href="/" class="btn-secundario" id="btnVolverInicio">‚Üê Volver a Inicio</a>
            </div>
            <div id="pantallaJuego" class="pantalla-juego">
                <div class="contenedor-pregunta">
                    <div class="barra-tiempo">
                        <div class="relleno-tiempo" id="rellenoTiempo"></div>
                    </div>
                    <div class="numero-pregunta" id="numeroPregunta">Pregunta 1 de 10</div>
                    <div class="texto-pregunta" id="textoPregunta"></div>
                    <div class="media-pregunta" id="mediaPregunta"></div>
                </div>
                <div class="cuadricula-respuestas" id="cuadriculaRespuestas"></div>
                <a href="/" class="btn-secundario" id="btnVolverInicioJuego">‚Üê Volver a Inicio</a>
            </div>
            <div id="pantallaResultados" class="pantalla-resultados">
                <div class="encabezado-resultados">
                    <h2>üéâ ¬°Juego Terminado!</h2>
                </div>
                <div class="mostrar-puntuacion">
                    <h3 id="puntuacionFinal">0</h3>
                    <p>Puntos Totales</p>
                </div>
                <div class="lista-clasificacion">
                    <h3 style="margin-bottom: 15px; color: #333;">üèÜ Ranking Final</h3>
                    <div id="listaClasificacion"></div>
                </div>
                <a href="/" class="btn-secundario" id="btnVolverInicioResultados" style="margin-top: 15px;">‚Üê Volver a Inicio</a>
            </div>
        </div>
    </div>

    <script>
        let preguntaActual = 0;
        let preguntas = [];
        let idParticipante = null;
        let idSesion = null;
        let puntuacion = 0;
        let intervaloReloj = null;
        let nombreUsuarioLogueado = null;
        let intervaloVerificacionSesion = null;
        let tiempoInicioPregunta = null;

        const parametrosURL = new URLSearchParams(window.location.search);
        const inicioAutomatico = parametrosURL.get('inicio_automatico');
        const idSesionURL = parametrosURL.get('id_sesion');
        const idParticipanteURL = parametrosURL.get('id_participante');

        if (inicioAutomatico === 'true' && idSesionURL && idParticipanteURL) {
            idSesion = idSesionURL;
            idParticipante = idParticipanteURL;
            const elementoUnirse = document.getElementById('pantallaUnirse');
            if (elementoUnirse) {
                elementoUnirse.style.display = 'none';
                elementoUnirse.classList.remove('activa');
            }
            fetch(`/api/sesion/${idSesion}/info`)
                .then(respuesta => respuesta.json())
                .then(datos => {
                    cargarPreguntas(datos.quiz.id).then(() => {
                        verificarProgreso();
                    });
                })
                .catch(error => {
                    alert('Error cargando el quiz');
                    window.location.href = '/';
                });
        }

        async function verificarProgreso() {
            if (!idParticipante) return;

            try {
                const respuesta = await fetch(`/api/participante/${idParticipante}/progreso`);
                const progreso = await respuesta.json();

                if (progreso.id_ultima_pregunta && preguntas.length > 0) {
                    const ultimoIndice = preguntas.findIndex(p => p.id === progreso.id_ultima_pregunta);

                    if (ultimoIndice >= 0 && ultimoIndice < preguntas.length - 1) {
                        preguntaActual = ultimoIndice + 1;
                        puntuacion = progreso.puntuacion_total || 0;
                        document.getElementById('pantallaJuego').classList.add('activa');
                        mostrarPregunta(preguntaActual);
                        iniciarVerificacionSesion();
                    } else if (ultimoIndice === preguntas.length - 1) {
                        puntuacion = progreso.puntuacion_total || 0;
                        mostrarResultados();
                    } else {
                        document.getElementById('pantallaJuego').classList.add('activa');
                        mostrarPregunta(0);
                        iniciarVerificacionSesion();
                    }
                } else {
                    document.getElementById('pantallaJuego').classList.add('activa');
                    mostrarPregunta(0);
                    iniciarVerificacionSesion();
                }
            } catch (error) {
                console.error('Error verificando progreso:', error);
                document.getElementById('pantallaJuego').classList.add('activa');
                mostrarPregunta(0);
                iniciarVerificacionSesion();
            }
        }

        function iniciarVerificacionSesion() {
            if (!idSesion) return;

            intervaloVerificacionSesion = setInterval(async () => {
                try {
                    const respuesta = await fetch(`/api/sesion/${idSesion}/verificar_estado`);
                    const datos = await respuesta.json();

                    if (!datos.activa || datos.estado === 'finalizada') {
                        clearInterval(intervaloVerificacionSesion);
                        clearInterval(intervaloReloj);
                        mostrarResultados();
                        alert('Tiempo agotado o cancelado. Juego finalizado.');
                    }
                } catch (error) {
                    console.error('Error verificando sesi√≥n:', error);
                }
            }, 2000);
        }

        window.addEventListener('beforeunload', () => {
            if (intervaloVerificacionSesion) clearInterval(intervaloVerificacionSesion);
            if (intervaloReloj) clearInterval(intervaloReloj);
        });

        function inicializarInterfazUsuario() {
            fetch('/api/info_sesion')
                .then(respuesta => respuesta.json())
                .then(datos => {
                    if (datos.nombre_usuario && !datos.es_profesor) {
                        nombreUsuarioLogueado = datos.nombre_usuario;
                        document.getElementById('nombreUsuarioNav').textContent = datos.nombre_usuario;
                        document.getElementById('barraNavegacion').classList.add('mostrar');
                        const botonesVolver = ['btnVolverInicio', 'btnVolverInicioJuego', 'btnVolverInicioResultados'];
                        botonesVolver.forEach(id => { 
                            const elemento = document.getElementById(id); 
                            if (elemento) elemento.classList.remove('mostrar'); 
                        });
                        const grupo = document.getElementById('grupoUsuario');
                        if (grupo) grupo.style.display = 'none';
                        const entradaUsuario = document.getElementById('nombreUsuario');
                        if (entradaUsuario) entradaUsuario.value = datos.nombre_usuario;
                    } else if (datos.nombre_usuario && datos.es_profesor) {
                        window.location.href = '/panel_control';
                    } else {
                        ['btnVolverInicio', 'btnVolverInicioJuego', 'btnVolverInicioResultados'].forEach(id => {
                            const elemento = document.getElementById(id);
                            if (elemento) elemento.classList.add('mostrar');
                        });
                        const entradaUsuario = document.getElementById('nombreUsuario');
                        if (entradaUsuario) entradaUsuario.required = true;
                    }
                })
                .catch(error => {
                    ['btnVolverInicio', 'btnVolverInicioJuego', 'btnVolverInicioResultados'].forEach(id => {
                        const elemento = document.getElementById(id);
                        if (elemento) elemento.classList.add('mostrar');
                    });
                    const entradaUsuario = document.getElementById('nombreUsuario');
                    if (entradaUsuario) entradaUsuario.required = true;
                });
        }

        inicializarInterfazUsuario();

        if (!(inicioAutomatico === 'true' && idSesionURL && idParticipanteURL)) {
            document.getElementById('formularioUnirse').addEventListener('submit', async function (e) {
                e.preventDefault();
                const codigoPin = document.getElementById('codigoPin').value.toUpperCase();
                const nombreUsuario = document.getElementById('nombreUsuario').value || nombreUsuarioLogueado;

                if (!nombreUsuario) {
                    mostrarAlerta('Por favor ingresa tu nombre');
                    return;
                }

                try {
                    const respuesta = await fetch('/api/unirse_juego', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ codigo_pin: codigoPin, nombre_usuario: nombreUsuario })
                    });
                    const datos = await respuesta.json();
                    if (respuesta.ok) {
                        
                        // ‚úÖ Lee el campo que s√≠ existe y que toda la app espera en snake_case
                        idParticipante = datos.id_participante;
                        idSesion = datos.id_sesion;
                        
                        // Validaci√≥n por si acaso
                        if (!idSesion || !idParticipante) {
                            alert('No se pudo unir a la sesi√≥n; faltan par√°metros.');
                            return;
                        }

                        if (datos.quiz.modo === 'grupal') {
                            // ‚úÖ Construye la URL usando id_sesion (coherente con seleccion_grupo.html y sala_espera.html)
                            window.location.href = `/seleccion_grupo?id_sesion=${idSesion}&id_participante=${idParticipante}`;
                            return;
                        }

                        await cargarPreguntas(datos.quiz.id);
                        document.getElementById('pantallaUnirse').classList.remove('activa');
                        document.getElementById('pantallaJuego').classList.add('activa');
                        mostrarPregunta(0);
                        iniciarVerificacionSesion();
                    } else {
                        mostrarAlerta(datos.error || 'Error al unirse al juego');
                    }
                } catch (error) {
                    mostrarAlerta('Error de conexi√≥n');
                }
            });
        }

        async function cargarPreguntas(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                preguntas = quiz.preguntas || [];
            } catch (error) {
                console.error('Error cargando preguntas:', error);
            }
        }

        function mostrarPregunta(indice) { 
            if (indice >= preguntas.length) { 
                mostrarResultados(); 
                return; 
            } 
            preguntaActual = indice; 
            const pregunta = preguntas[indice]; 
            document.getElementById('numeroPregunta').textContent = `Pregunta ${indice + 1} de ${preguntas.length}`;
            document.getElementById('textoPregunta').textContent = pregunta.texto_pregunta; 
            const media = document.getElementById('mediaPregunta'); 
            media.innerHTML = pregunta.url_imagen ? `<img src="${pregunta.url_imagen}" alt="Imagen de la pregunta">` : '';
            const cuadriculaRespuestas = document.getElementById('cuadriculaRespuestas'); 
            cuadriculaRespuestas.innerHTML = pregunta.opciones.map((opcion, i) => 
                `<button class="btn-respuesta" onclick="seleccionarRespuesta(${i}, ${pregunta.id}, ${opcion.id})">
            <div class="letra-respuesta">${String.fromCharCode(65 + i)}</div> 
            <div class="texto-respuesta">${opcion.texto_opcion}</div> 
        </button>` 
            ).join(''); 
            iniciarReloj(pregunta.tiempo_limite); 
        } 

        function iniciarReloj(segundos) {
            let tiempoRestante = segundos;
            tiempoInicioPregunta = Date.now();
            const relleno = document.getElementById('rellenoTiempo');
            relleno.style.width = '100%';

            if (intervaloReloj) clearInterval(intervaloReloj);

            intervaloReloj = setInterval(() => {
                tiempoRestante--;
                const porcentaje = (tiempoRestante / segundos) * 100;
                relleno.style.width = porcentaje + '%';

                if (tiempoRestante <= 0) {
                    clearInterval(intervaloReloj);
                    setTimeout(() => {
                        mostrarPregunta(preguntaActual + 1);
                    }, 1000);
                }
            }, 1000);
        }

        async function seleccionarRespuesta(indiceOpcion, idPregunta, idOpcion) {
            if (intervaloReloj) clearInterval(intervaloReloj);

            const pregunta = preguntas[preguntaActual];
            const opcionSeleccionada = pregunta.opciones[indiceOpcion];
            const esCorrecta = opcionSeleccionada.es_correcta;

            const tiempoTranscurrido = (Date.now() - tiempoInicioPregunta) / 1000;
            const tiempoUtilizado = Math.min(tiempoTranscurrido, pregunta.tiempo_limite);

            const puntos = esCorrecta ? Math.max(100, 1000 - (tiempoUtilizado * 10)) : 0;
            if (esCorrecta) puntuacion += puntos;

            const botones = document.querySelectorAll('.btn-respuesta');
            botones.forEach((boton, i) => {
                boton.disabled = true;
                if (pregunta.opciones[i].es_correcta) {
                    boton.classList.add('correcta');
                } else if (i === indiceOpcion && !esCorrecta) {
                    boton.classList.add('incorrecta');
                }
            });

            try {
                await fetch('/api/guardar_respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Claves alineadas con el backend (app.py)
                        id_participante: idParticipante,
                        id_pregunta: idPregunta,
                        id_opcion: idOpcion,
                        tiempo_respuesta: tiempoUtilizado,
                        puntos_ganados: puntos
                    })
                });
            } catch (error) {
                console.error('Error guardando respuesta:', error);
            }

            setTimeout(() => {
                mostrarPregunta(preguntaActual + 1);
            }, 2000);
        }

        async function mostrarResultados() {
            if (intervaloVerificacionSesion) clearInterval(intervaloVerificacionSesion);

            document.getElementById('pantallaJuego').classList.remove('activa');
            document.getElementById('pantallaResultados').classList.add('activa');
            document.getElementById('puntuacionFinal').textContent = Math.round(puntuacion);

            try {
                const respuesta = await fetch(`/api/resultados_juego/${idSesion}`);
                const clasificacion = await respuesta.json();
                const lista = document.getElementById('listaClasificacion');

                lista.innerHTML = clasificacion.map((participante, indice) => {
                    const clase = indice === 0 ? 'primero' : indice === 1 ? 'segundo' : indice === 2 ? 'tercero' : '';
                    const medalla = indice === 0 ? 'ü•á' : indice === 1 ? 'ü•à' : indice === 2 ? 'ü•â' : '';
                    return `<div class="item-clasificacion">
                <div class="posicion-clasificacion ${clase}">${medalla || (indice + 1)}</div>
                <div class="nombre-clasificacion">${participante.nombre_usuario}</div>
                <div class="puntuacion-clasificacion">${participante.puntuacion_total} pts</div>
            </div>`;
                }).join('');

                const encabezadoResultados = document.querySelector('.encabezado-resultados');
                const botonAnteriorRepetir = document.getElementById('btnRepetir');
                const botonAnteriorSalir = document.getElementById('btnSalir');
                if (botonAnteriorRepetir) botonAnteriorRepetir.remove();
                if (botonAnteriorSalir) botonAnteriorSalir.remove();

                const respuestaSesion = await fetch(`/api/sesion/${idSesion}/info`);
                const informacionSesion = await respuestaSesion.json();
                const intentosRestantes = informacionSesion.intentos_restantes || 0;
                const idQuiz = informacionSesion.quiz?.id;

                if (intentosRestantes > 0) {
                    const btnRepetir = document.createElement('button');
                    btnRepetir.className = 'btn';
                    btnRepetir.id = 'btnRepetir';
                    btnRepetir.textContent = 'Jugar Otra Vez';
                    btnRepetir.style.marginTop = '12px';
                    btnRepetir.addEventListener('click', async function () {
                        try {
                            const respuestaConsumir = await fetch(`/api/sesion/${idSesion}/consumir_intento`, { method: 'POST' });
                            const datosConsumir = await respuestaConsumir.json();
                            if (respuestaConsumir.ok) {
                                alert(`Intento consumido. Intentos restantes: ${datosConsumir.intentos_restantes}`);
                                iniciarQuizDesdeCero(idQuiz);
                            } else {
                                alert('‚ùå ' + (datosConsumir.error || 'No se pudo consumir el intento'));
                            }
                        } catch (error) {
                            alert('Error de conexi√≥n al consumir intento');
                        }
                    });
                    encabezadoResultados.appendChild(btnRepetir);
                } else {
                    const btnSalir = document.createElement('button');
                    btnSalir.className = 'btn';
                    btnSalir.id = 'btnSalir';
                    btnSalir.textContent = 'Salir';
                    btnSalir.style.marginTop = '12px';
                    btnSalir.addEventListener('click', function () {
                        window.location.href = '/jugar';
                    });
                    encabezadoResultados.appendChild(btnSalir);
                }
            } catch (error) {
                console.error('Error al mostrar resultados:', error);
            }
        }

        async function iniciarQuizDesdeCero(idQuiz) {
            try {
                if (!preguntas || preguntas.length === 0) {
                    await cargarPreguntas(idQuiz);
                }

                if (!preguntas || preguntas.length === 0) {
                    alert('No se pudo cargar el quiz para reiniciar.');
                    window.location.href = '/jugar';
                    return;
                }

                preguntaActual = 0;
                puntuacion = 0;
                if (intervaloReloj) {
                    clearInterval(intervaloReloj);
                    intervaloReloj = null;
                }

                const elementoUnirse = document.getElementById('pantallaUnirse');
                if (elementoUnirse) { elementoUnirse.style.display = 'none'; elementoUnirse.classList.remove('activa'); }
                document.getElementById('pantallaResultados').classList.remove('activa');
                document.getElementById('pantallaJuego').classList.add('activa');

                mostrarPregunta(0);

                iniciarVerificacionSesion();
            } catch (error) {
                console.error('Error reiniciando quiz:', error);
                alert('Error reiniciando el quiz.');
                window.location.href = '/jugar';
            }
        }

        function mostrarAlerta(mensaje) {
            const elemento = document.getElementById('alertaError');
            elemento.textContent = mensaje;
            elemento.classList.add('mostrar');
            setTimeout(() => elemento.classList.remove('mostrar'), 5000);
        }
    </script>

</body>

</html>
