<!-- templates/panel_profesor.html -->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - QuizPlatform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .barra-navegacion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .barra-navegacion h1 {
            font-size: 1.8em;
        }

        .derecha-navegacion {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .boton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .boton:hover {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .boton-principal {
            background: white;
            color: #667eea;
        }

        .boton-principal:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .contenedor {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .cuadricula-estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tarjeta-estadistica {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .icono-estadistica {
            font-size: 3em;
        }

        .info-estadistica h3 {
            color: #333;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .info-estadistica p {
            color: #666;
        }

        .encabezado-seccion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .encabezado-seccion h2 {
            color: #333;
            font-size: 2em;
        }

        .cuadricula-quizzes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .tarjeta-quiz {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tarjeta-quiz:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .tarjeta-quiz h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .tarjeta-quiz p {
            color: #666;
            margin-bottom: 15px;
        }

        .meta-quiz {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #999;
        }

        .codigo-pin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .acciones-quiz {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .boton-pequeno {
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .boton-editar {
            background: #4caf50;
            color: white;
        }

        .boton-editar:hover {
            background: #45a049;
        }

        .boton-compartir {
            background: #2196f3;
            color: white;
        }

        .boton-compartir:hover {
            background: #0d8bf2;
        }

        .boton-eliminar {
            background: #f44336;
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .boton-eliminar:hover {
            background: #da190b;
        }

        .boton-duplicar {
            background: #ff9800;
            color: white;
        }

        .boton-duplicar:hover {
            background: #e68900;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.activo {
            display: flex;
        }

        .contenido-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .encabezado-modal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .encabezado-modal h2 {
            color: #333;
        }

        .boton-cerrar {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }

        .boton-cerrar:hover {
            color: #333;
        }

        .grupo-formulario {
            margin-bottom: 20px;
        }

        .grupo-formulario label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .grupo-formulario input,
        .grupo-formulario textarea,
        .grupo-formulario select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
        }

        .grupo-formulario textarea {
            resize: vertical;
            min-height: 100px;
        }

        .grupo-casilla-verificacion {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grupo-casilla-verificacion input {
            width: auto;
        }

        .estado-vacio {
            text-align: center;
            padding: 60px 20px;
        }

        .icono-estado-vacio {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .estado-vacio h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .estado-vacio p {
            color: #999;
            margin-bottom: 20px;
        }

        .dialogo-confirmacion {
            text-align: center;
        }

        .dialogo-confirmacion h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .dialogo-confirmacion p {
            color: #666;
            margin-bottom: 30px;
        }

        .acciones-confirmacion {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .boton-confirmar {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
        }

        .boton-si {
            background: #f44336;
            color: white;
        }

        .boton-no {
            background: #e0e0e0;
            color: #333;
        }

        .tarjeta-sesion {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border-left: 5px solid #4caf50;
        }

        .tarjeta-sesion.esperando {
            border-left-color: #ff9800;
        }

        .tarjeta-sesion.iniciada {
            border-left-color: #4caf50;
        }

        .encabezado-sesion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .titulo-sesion {
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
        }

        .estado-sesion {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .estado-sesion.esperando {
            background: #fff3cd;
            color: #856404;
        }

        .estado-sesion.iniciada {
            background: #d4edda;
            color: #155724;
        }

        .info-sesion {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: #666;
        }

        .info-sesion span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .boton-iniciar-quiz {
            background: #4caf50;
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .boton-iniciar-quiz:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .boton-iniciar-quiz:deshabilitado {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #modalCompartirQuiz .contenido-modal {
            background: linear-gradient(135deg, #ffffff, #f0f3ff);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
        }

        /* Fila de opci√≥n bien alineada: 3 columnas (check | texto | üóëÔ∏è) */
        .opcion {
            display: grid;
            grid-template-columns: 28px 1fr 44px;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        /* Que NO herede el width:100% global; aqu√≠ manda el grid */
        .grupo-formulario .opcion input[type="text"] {
            width: 100% !important;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        /* Checkbox m√°s claro y clic s√≥lo sobre √©l */
        .grupo-formulario .opcion input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
            cursor: pointer;
        }

        /* Bot√≥n üóëÔ∏è consistente */
        .opcion .boton-eliminar {
            min-width: 44px;
            height: 40px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Contenedor para ‚ÄúAgregar opci√≥n‚Äù y ‚ÄúEliminar pregunta‚Äù, alineados a la derecha */
        .opcion-acciones {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="barra-navegacion">
        <h1>üéØ QuizPlatform</h1>
        <div class="derecha-navegacion">
            <span>Bienvenido, <strong id="nombreUsuario"></strong></span>
            <button class="boton boton-principal" onclick="abrirModalCrear()">+ Crear Quiz</button>
            <a href="/cerrar_sesion" class="boton">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="contenedor">
        <div class="cuadricula-estadisticas">
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üìö</div>
                <div class="info-estadistica">
                    <h3 id="totalQuizzes">0</h3>
                    <p>Quizzes Creados</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üéÆ</div>
                <div class="info-estadistica">
                    <h3 id="totalGames">0</h3>
                    <p>Partidas Jugadas</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üë•</div>
                <div class="info-estadistica">
                    <h3 id="totalparticipantes">0</h3>
                    <p>Participantes</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">‚≠ê</div>
                <div class="info-estadistica">
                    <h3 id="totalPublic">0</h3>
                    <p>Quizzes P√∫blicos</p>
                </div>
            </div>
        </div>

        <!-- Sesiones Activas (Modo Grupal) -->
        <div id="seccionSesionesActivas" style="display: none; margin-bottom: 30px;">
            <div class="encabezado-seccion">
                <h2>üéÆ Sesiones Grupales Activas</h2>
            </div>
            <div id="contenedorSesionesActivas"></div>
        </div>

        <div class="encabezado-seccion">
            <h2 id="tituloQuizzes">Todos los Quizzes</h2>
            <div>
                <button class="boton" onclick="cargarQuizzes('todos')">Todos</button>
                <button class="boton" onclick="cargarQuizzes('mios')">M√≠os</button>
            </div>
        </div>

        <div id="contenedorQuizzes"></div>
    </div>

    <!-- Modal Crear/Editar Quiz -->
    <div class="modal" id="modalQuiz">
        <div class="contenido-modal">
            <div class="encabezado-modal">
                <h2 id="tituloModal">Crear Nuevo Quiz</h2>
                <button class="boton-cerrar" onclick="cerrarModal('modalQuiz')">&times;</button>
            </div>
            <form id="formularioQuiz">
                <input type="hidden" id="idQuiz">
                <div class="grupo-formulario">
                    <label for="titulo">T√≠tulo del Quiz:</label>
                    <input type="text" id="titulo" required>
                </div>
                <div class="grupo-formulario">
                    <label for="descripcion">Descripci√≥n:</label>
                    <textarea id="descripcion"></textarea>
                </div>
                <div class="grupo-formulario">
                    <label for="modo">Modo de Juego:</label>
                    <select id="modo" onchange="alternarEntradaGrupos()">
                        <option value="individual">Individual</option>
                        <option value="grupal">Grupal</option>
                    </select>
                </div>
                <div class="grupo-formulario" id="contenedorNumGrupos" style="display: none;">
                    <label for="numGrupos">N√∫mero de Grupos:</label>
                    <input type="number" id="numGrupos" min="2" max="20" value="4">
                </div>
                <div class="grupo-formulario">
                    <div class="grupo-casilla-verificacion">
                        <input type="checkbox" id="esPublico" checked>
                        <label for="esPublico">Hacer p√∫blico (otros usuarios pueden usarlo)</label>
                    </div>
                </div>
                <button type="submit" class="boton">Guardar Quiz</button>
            </form>
        </div>
    </div>

    <!-- Modal Preguntas del Quiz -->
    <div class="modal" id="modalPreguntasQuiz">
        <div class="contenido-modal" style="max-width: 900px;">
            <div class="encabezado-modal">
                <h2>Preguntas del Quiz</h2>
                <button class="boton-cerrar" onclick="cerrarModal('modalPreguntasQuiz')">&times;</button>
            </div>

            <div id="listaPreguntas"></div>

            <div class="acciones-confirmacion" style="margin-top: 20px;">
                <button class="boton" onclick="agregarPregunta()">‚ûï Nueva Pregunta</button>
                <button class="boton" style="background:#4caf50;" onclick="guardarPreguntas()">üíæ Guardar</button>

            </div>
        </div>
    </div>

    <!-- Modal Compartir Quiz -->
    <div class="modal" id="modalCompartirQuiz">
        <div class="contenido-modal" style="max-width: 600px; text-align: center; padding: 40px;">
            <div class="encabezado-modal" style="justify-content: center;">
                <h2 style="font-size: 2rem;">üéØ ¬°Comparte tu Quiz!</h2>
            </div>
            <p id="textoCompartir" style="font-size: 1.2rem; margin: 20px 0;"></p>
            <button class="boton" onclick="cerrarModal('modalCompartirQuiz')">Cerrar</button>
        </div>
    </div>



    <!-- Modal Confirmaci√≥n -->
    <div class="modal" id="modalConfirmacion">
        <div class="contenido-modal">
            <div class="dialogo-confirmacion">
                <h3 id="tituloConfirmacion">¬øEst√°s seguro?</h3>
                <p id="mensajeConfirmacion">Esta acci√≥n no se puede deshacer.</p>
                <div class="acciones-confirmacion">
                    <button class="boton-confirmar boton-si" onclick="confirmarAccion()">S√≠, continuar</button>
                    <button class="boton-confirmar boton-no"
                        onclick="cerrarModal('modalConfirmacion')">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let idQuizActual = null;
        let callbackConfirmacion = null;
        let idUsuarioActual = null;

        function obtenerIdUsuarioActual() {
            return idUsuarioActual;
        }

        // ‚úÖ CORRECCI√ìN CR√çTICA: Usar /api/info_sesion en lugar de /api/usuarios
        async function cargarInfoUsuario() {
            try {
                const respuesta = await fetch('/api/info_sesion');
                const datos = await respuesta.json();

                console.log('üìä Datos de sesi√≥n recibidos:', datos);

                if (!datos.id_usuario) {
                    console.error('‚ùå No hay ID de usuario en la sesi√≥n');
                    alert('‚ö†Ô∏è Sesi√≥n inv√°lida. Por favor inicia sesi√≥n nuevamente.');
                    window.location.href = '/iniciar_sesion';
                    return false;
                }

                if (!datos.es_profesor) {
                    console.error('‚ùå Usuario no es profesor:', datos.es_profesor);
                    alert('‚ö†Ô∏è Acceso denegado. Esta √°rea es solo para profesores.');
                    window.location.href = '/';
                    return false;
                }

                // ‚úÖ Almacenar datos del usuario
                idUsuarioActual = datos.id_usuario;
                document.getElementById('nombreUsuario').textContent = datos.nombre_usuario || 'Profesor';

                console.log('‚úÖ Usuario profesor autenticado:', {
                    id: idUsuarioActual,
                    nombre: datos.nombre_usuario,
                    es_profesor: datos.es_profesor
                });

                return true;
            } catch (error) {
                console.error('‚ùå Error al cargar informaci√≥n del usuario:', error);
                alert('‚ö†Ô∏è Error de conexi√≥n. Por favor recarga la p√°gina.');
                window.location.href = '/iniciar_sesion';
                return false;
            }
        }

        async function cargarQuizzes(filtro = 'todos') {
            try {
                const respuesta = await fetch('/api/quizzes');
                const quizzes = await respuesta.json();
                const contenedor = document.getElementById('contenedorQuizzes');
                const elementoTitulo = document.getElementById('tituloQuizzes');

                elementoTitulo.textContent = (filtro === 'mios') ? 'Mis Quizzes' : 'Todos los Quizzes';

                if (quizzes.length === 0) {
                    contenedor.innerHTML = `<div class="estado-vacio"><div class="icono-estado-vacio">üìù</div><h3>No tienes quizzes a√∫n</h3><p>Crea tu primer quiz para empezar</p><button class="boton" onclick="abrirModalCrear()">Crear Quiz</button></div>`;
                    return;
                }

                let quizzesFiltrados = quizzes;
                if (filtro === 'mios') {
                    quizzesFiltrados = quizzes.filter(q => q.id_profesor == obtenerIdUsuarioActual());
                }

                if (quizzesFiltrados.length === 0) {
                    const nombreFiltro = filtro === 'mios' ? 'tuyos' : '';
                    contenedor.innerHTML = `<div class="estado-vacio"><div class="icono-estado-vacio">üîç</div><h3>No hay quizzes ${nombreFiltro}</h3><p>Intenta con otro filtro o crea un nuevo quiz</p><button class="boton" onclick="cargarQuizzes('todos')">Ver Todos</button></div>`;
                    return;
                }

                contenedor.innerHTML = '<div class="cuadricula-quizzes">' + quizzesFiltrados.map(quiz => `
                    <div class="tarjeta-quiz">
                        <h3>${quiz.titulo}</h3>
                        <p>${quiz.descripcion || 'Sin descripci√≥n'}</p>
                        <div class="meta-quiz">
                            <span>üéÆ ${quiz.modo === 'grupal' ? 'Grupal' : 'Individual'}</span>
                            <span>${quiz.es_publico ? 'üåê P√∫blico' : 'üîí Privado'}</span>
                        </div>
                        <div class="codigo-pin">PIN: ${quiz.codigo_pin}</div>
                        <div class="acciones-quiz" style="margin-top: 15px;">
                            ${quiz.id_profesor == obtenerIdUsuarioActual() ? `
                            <button class="boton-pequeno boton-editar" onclick="editarQuiz(${quiz.id})">‚úèÔ∏è Editar</button>
                            <button class="boton-pequeno boton-editar" onclick="gestionarPreguntas(${quiz.id})">üìù Preguntas</button>
                            ` : `
                            <button class="boton-pequeno boton-editar" onclick="gestionarPreguntas(${quiz.id})">üìù Preguntas</button>
                            `}
                            <button class="boton-pequeno boton-compartir" onclick="compartirQuiz('${quiz.codigo_pin}')">üîó Compartir</button>
                            <button class="boton-pequeno boton-duplicar" onclick="duplicarQuiz(${quiz.id})">üìã Duplicar</button>
                            ${quiz.id_profesor == obtenerIdUsuarioActual() ? `
                            <button class="boton-pequeno boton-eliminar" onclick="confirmarEliminarQuiz(${quiz.id})">üóëÔ∏è Eliminar</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('') + '</div>';

                actualizarEstadisticas(quizzes);
            } catch (error) {
                console.error('Error cargando quizzes:', error);
            }
        }

        function actualizarEstadisticas(quizzes) {
            const misQuizzes = quizzes.filter(q => q.id_profesor == obtenerIdUsuarioActual());
            document.getElementById('totalQuizzes').textContent = misQuizzes.length;
            document.getElementById('totalPublic').textContent = quizzes.filter(q => q.es_publico).length;
        }

        function alternarEntradaGrupos() {
            const modo = document.getElementById('modo').value;
            const contenedor = document.getElementById('contenedorNumGrupos');
            contenedor.style.display = modo === 'grupal' ? 'block' : 'none';
        }

        function abrirModalCrear() {
            document.getElementById('tituloModal').textContent = 'Crear Nuevo Quiz';
            document.getElementById('formularioQuiz').reset();
            document.getElementById('idQuiz').value = '';
            alternarEntradaGrupos();
            document.getElementById('modalQuiz').classList.add('activo');
        }

        async function editarQuiz(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                document.getElementById('tituloModal').textContent = 'Editar Quiz';
                document.getElementById('idQuiz').value = quiz.id;
                document.getElementById('titulo').value = quiz.titulo;
                document.getElementById('descripcion').value = quiz.descripcion || '';
                document.getElementById('modo').value = quiz.modo;
                document.getElementById('numGrupos').value = quiz.num_grupos || 4;
                document.getElementById('esPublico').checked = quiz.es_publico;
                alternarEntradaGrupos();
                document.getElementById('modalQuiz').classList.add('activo');
            } catch (error) {
                alert('Error cargando el quiz');
            }
        }

        let idQuizSeleccionado = null;
        let quizData = {}; // Cache local de preguntas para operaciones in-place
        async function gestionarPreguntas(idQuiz) {
            try {
                idQuizSeleccionado = idQuiz;
                document.getElementById('listaPreguntas').innerHTML = '<p style="color:#666;">Cargando preguntas...</p>';
                document.getElementById('modalPreguntasQuiz').classList.add('activo');

                // Trae quiz con preguntas embebidas (tu endpoint /api/quizzes/<id> ya lo devuelve as√≠)
                const resp = await fetch(`/api/quizzes/${idQuizSeleccionado}`);
                if (!resp.ok) throw new Error('No se pudo cargar el quiz');
                quizData = await resp.json();

                mostrarPreguntas(quizData.preguntas || []);
            } catch (e) {
                alert('‚ùå Error al cargar preguntas');
                console.error(e);
            }
        }

        function mostrarPreguntas(preguntas) {
            const cont = document.getElementById('listaPreguntas');
            if (!preguntas || preguntas.length === 0) {
                cont.innerHTML = `
                <div class="estado-vacio">
                <div class="icono-estado-vacio">üìù</div>
                <h3>No hay preguntas a√∫n</h3>
                <p>Agrega tu primera pregunta</p>
                </div>`;
                return;
            }
            cont.innerHTML = preguntas.map((pregunta) => {
                const opcionesHTML = (pregunta.opciones || []).map((opcion) => `
                <div class="opcion">
                <input id="opt-check-${pregunta.id}-${opcion.id}" type="checkbox"
                    ${opcion.es_correcta ? 'checked' : ''}
                    onchange="marcarCorrecta(${pregunta.id}, ${opcion.id}, this.checked)">
                <input id="opt-text-${pregunta.id}-${opcion.id}" type="text"
                    value="${opcion.texto_opcion || ''}"
                    onchange="actualizarOpcion(${pregunta.id}, ${opcion.id}, this.value)">
                <button class="boton-eliminar"
                    onclick="eliminarOpcion(${pregunta.id}, ${opcion.id})">üóëÔ∏è</button>
                </div>
            `).join('');

                return `
                <div class="tarjeta-quiz" style="border-left:4px solid #667eea; margin-bottom: 15px;">
                <div class="grupo-formulario">
                    <label>Texto de la pregunta</label>
                    <input id="preg-text-${pregunta.id}" type="text"
                        value="${pregunta.texto_pregunta}"
                        onchange="actualizarPregunta(${pregunta.id}, this.value)">
                </div>
                <div class="grupo-formulario">
                    <label>Tiempo l√≠mite (segundos)</label>
                    <input id="preg-tiempo-${pregunta.id}" type="number"
                        value="${pregunta.tiempo_limite || 30}"
                        onchange="actualizarTiempo(${pregunta.id}, this.value)">
                </div>
                <div class="grupo-formulario">
                    <label>URL de imagen (opcional)</label>
                    <input id="preg-img-${pregunta.id}" type="text"
                        value="${pregunta.url_imagen || ''}"
                        onchange="actualizarImagen(${pregunta.id}, this.value)">
                </div>
                <div class="grupo-formulario">
                    <label>URL de video (opcional)</label>
                    <input id="preg-video-${pregunta.id}" type="text"
                        value="${pregunta.url_video || ''}"
                        onchange="actualizarVideo(${pregunta.id}, this.value)">
                </div>
                <div class="grupo-formulario">
                    <label>Opciones</label>
                    ${opcionesHTML}
                    <div class="opcion-acciones">
                    <button class="boton" onclick="agregarOpcion(${pregunta.id})">‚ûï Agregar opci√≥n</button>
                    <button class="boton-eliminar" onclick="eliminarPregunta(${pregunta.id})">‚ùå Eliminar pregunta</button>
                    </div>
                </div>
                </div>
            `;
            }).join('');
        }

        async function recargarPreguntas() {
            const resp = await fetch(`/api/quizzes/${idQuizSeleccionado}`);
            const data = await resp.json();
            quizData = data;
            mostrarPreguntas(quizData.preguntas || []);
        }


        function snapshotCamposPreguntas() {
            const vals = {};
            // Inputs de texto y n√∫mero
            document.querySelectorAll('#listaPreguntas input[type="text"], #listaPreguntas input[type="number"]').forEach(inp => {
                vals[inp.id] = inp.value;
            });
            // Checkboxes
            document.querySelectorAll('#listaPreguntas input[type="checkbox"]').forEach(chk => {
                vals[chk.id] = chk.checked;
            });
            return vals;
        }

        function restoreCamposPreguntas(vals) {
            if (!vals) return;
            for (const [id, v] of Object.entries(vals)) {
                const el = document.getElementById(id);
                if (!el) continue; // puede ser nuevo / eliminado
                if (el.type === 'checkbox') el.checked = !!v;
                else el.value = v;
            }
        }



        async function agregarPregunta() {
            if (!idQuizSeleccionado) { alert('‚ö†Ô∏è No hay quiz seleccionado'); return; }
            const snapshot = snapshotCamposPreguntas();
            const nueva = {
                texto_pregunta: "Nueva pregunta",
                tiempo_limite: 30,
                posicion: (quizData.preguntas?.length || 0) + 1,
                opciones: [
                    { texto_opcion: "Opci√≥n A", es_correcta: false },
                    { texto_opcion: "Opci√≥n B", es_correcta: true }
                ]
            };
            const resp = await fetch(`/api/quizzes/${idQuizSeleccionado}/preguntas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nueva)
            });
            if (resp.ok) {
                await recargarPreguntas();
                restoreCamposPreguntas(snapshot);
            } else {
                alert('‚ùå Error al agregar la pregunta');
            }
        }



        async function actualizarPregunta(idPregunta, texto) {
            const resp = await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto_pregunta: texto })
            });
            if (!resp.ok) alert('‚ùå Error al actualizar pregunta');
        }

        async function actualizarTiempo(idPregunta, tiempo) {
            const resp = await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tiempo_limite: parseInt(tiempo) })
            });
            if (!resp.ok) alert('‚ùå Error al actualizar tiempo');
        }

        async function actualizarImagen(idPregunta, url) {
            const resp = await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url_imagen: url })
            });
            if (!resp.ok) alert('‚ùå Error al actualizar imagen');
        }

        async function actualizarVideo(idPregunta, url) {
            const resp = await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url_video: url })
            });
            if (!resp.ok) alert('‚ùå Error al actualizar video');
        }

        async function agregarOpcion(idPregunta) {
            const snapshot = snapshotCamposPreguntas(); // ‚Üê congelar
            const pregunta = quizData.preguntas.find(p => p.id === idPregunta);
            const nuevasOpciones = (pregunta.opciones || []).concat([{ texto_opcion: "Nueva opci√≥n", es_correcta: false }]);
            await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ opciones: nuevasOpciones })
            });
            await recargarPreguntas();                 // ‚Üê re-render
            restoreCamposPreguntas(snapshot);          // ‚Üê restaurar lo escrito
        }



        async function actualizarOpcion(idPregunta, idOpcion, texto) {
            const pregunta = quizData.preguntas.find(p => p.id === idPregunta);
            const nuevasOpciones = (pregunta.opciones || []).map(o => o.id === idOpcion ? { ...o, texto_opcion: texto } : o);
            await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ opciones: nuevasOpciones })
            });
        }

        async function marcarCorrecta(idPregunta, idOpcion, checked) {
            const pregunta = quizData.preguntas.find(p => p.id === idPregunta);
            const nuevasOpciones = (pregunta.opciones || []).map(o => o.id === idOpcion ? { ...o, es_correcta: checked } : o);
            await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ opciones: nuevasOpciones })
            });
        }


        async function eliminarOpcion(idPregunta, idOpcion) {
            const snapshot = snapshotCamposPreguntas();
            const pregunta = quizData.preguntas.find(p => p.id === idPregunta);
            const nuevasOpciones = (pregunta.opciones || []).filter(o => o.id !== idOpcion);
            await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ opciones: nuevasOpciones })
            });
            await recargarPreguntas();
            restoreCamposPreguntas(snapshot);
        }


        async function eliminarPregunta(idPregunta) {
            if (!confirm('¬øSeguro que deseas eliminar esta pregunta?')) return;
            const snapshot = snapshotCamposPreguntas();
            const resp = await fetch(`/api/preguntas/${idPregunta}`, { method: 'DELETE' });
            if (resp.ok) {
                await recargarPreguntas();
                restoreCamposPreguntas(snapshot);
            } else {
                alert('‚ùå No se pudo eliminar la pregunta');
            }
        }


        async function guardarPreguntas() {
            if (!quizData || !quizData.preguntas || quizData.preguntas.length === 0) {
                alert('No hay preguntas para guardar');
                return;
            }

            try {
                // Recorremos las preguntas que est√°n renderizadas
                for (const p of quizData.preguntas) {
                    // 1) Leer valores visibles del DOM (aunque no hayan perdido foco)
                    const texto_pregunta = document.getElementById(`preg-text-${p.id}`)?.value ?? p.texto_pregunta ?? '';
                    const tiempo_limite = parseInt(document.getElementById(`preg-tiempo-${p.id}`)?.value ?? p.tiempo_limite ?? 30, 10) || 30;
                    const url_imagen = document.getElementById(`preg-img-${p.id}`)?.value ?? p.url_imagen ?? null;
                    const url_video = document.getElementById(`preg-video-${p.id}`)?.value ?? p.url_video ?? null;

                    // 2) Leer opciones visibles del DOM
                    const opciones_leidas = (p.opciones || []).map(o => {
                        const texto = document.getElementById(`opt-text-${p.id}-${o.id}`)?.value ?? o.texto_opcion ?? '';
                        const check = !!document.getElementById(`opt-check-${p.id}-${o.id}`)?.checked;
                        return { texto_opcion: texto, es_correcta: check };
                    });

                    // 3) PUT a /api/preguntas/<id>
                    const resp = await fetch(`/api/preguntas/${p.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            texto_pregunta,
                            url_imagen,
                            url_video,
                            tiempo_limite,
                            posicion: p.posicion || 0,
                            opciones: opciones_leidas
                        })
                    });

                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        console.error('Error guardando pregunta', p.id, err);
                        alert('‚ùå Error al guardar alguna pregunta. Revisa consola.');
                        return;
                    }
                }

                alert('‚úÖ Preguntas guardadas correctamente');
                await recargarPreguntas(); // refrescamos lo mostrado
            } catch (e) {
                console.error(e);
                alert('‚ùå Error de conexi√≥n guardando preguntas');
            }
        }


        function compartirQuiz(codigoPin) {
            const urlJuego = `${window.location.origin}/jugar`;
            // armar el contenido grande del modal
            const mensajeHTML = `
                <div style="margin-top: 6px;">
                <p style="font-size:1.2rem; margin: 8px 0 2px;">Entra a:</p>
                <p style="font-weight:bold; color:#667eea; font-size:1.5rem; word-break: break-all;">${urlJuego}</p>
                <p style="margin-top:16px; font-size:1.1rem;">PIN:</p>
                <p style="font-size:2rem; font-weight:800; letter-spacing:3px; color:#333;">${codigoPin}</p>
                </div>
            `;
            // poner contenido y abrir el modal
            const cont = document.getElementById('textoCompartir');
            cont.innerHTML = mensajeHTML;
            document.getElementById('modalCompartirQuiz').classList.add('activo');
            // extra: copiar al portapapeles el texto ya formateado
            const textoPlano = `üéØ √önete a mi quiz!\n\nEntra a: ${urlJuego}\nPIN: ${codigoPin}`;
            navigator.clipboard.writeText(textoPlano).catch(() => { });
        }

        async function duplicarQuiz(idQuiz) {
            if (!confirm('¬øDeseas duplicar este quiz y sus preguntas?')) return;
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                if (!quiz || !quiz.id) {
                    alert('No se pudo cargar el quiz original');
                    return;
                }

                const nuevoQuiz = {
                    titulo: quiz.titulo + ' (Copia)',
                    descripcion: quiz.descripcion,
                    modo: quiz.modo,
                    num_grupos: quiz.num_grupos || 0,
                    es_publico: false
                };

                const respuestaCrear = await fetch('/api/quizzes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoQuiz)
                });

                const creado = await respuestaCrear.json();
                // ‚úÖ CORREGIDO: Usar 'id_quiz' (no 'quiz_id')
                if (!respuestaCrear.ok || !creado.id_quiz) {
                    alert('No se pudo crear la copia');
                    return;
                }

                const nuevoIdQuiz = creado.id_quiz;

                const preguntas = quiz.preguntas || [];
                for (const p of preguntas) {
                    const cargaUtil = {
                        texto_pregunta: p.texto_pregunta,
                        url_imagen: p.url_imagen,
                        url_video: p.url_video,
                        tiempo_limite: p.tiempo_limite,
                        posicion: p.posicion || 0,
                        opciones: (p.opciones || []).map(o => ({
                            texto_opcion: o.texto_opcion,   // ‚úÖ Est√°ndar con la BD y el backend
                            es_correcta: !!o.es_correcta
                        }))
                    };
                    await fetch(`/api/quizzes/${nuevoIdQuiz}/preguntas`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cargaUtil)
                    });
                }

                alert('‚úÖ Quiz duplicado exitosamente con sus preguntas');
                if (confirm('¬øDeseas abrir el editar de preguntas de la copia?')) {
                    gestionarPreguntas(nuevoIdQuiz);
                } else {
                    cargarQuizzes();
                }
            } catch (error) {
                console.error(error);
                alert('Error duplicando el quiz');
            }
        }

        function confirmarEliminarQuiz(idQuiz) {
            document.getElementById('tituloConfirmacion').textContent = '¬øEliminar Quiz?';
            document.getElementById('mensajeConfirmacion').textContent = 'Esta acci√≥n eliminar√° el quiz y todas sus preguntas. No se puede deshacer.';
            callbackConfirmacion = () => eliminarQuiz(idQuiz);
            document.getElementById('modalConfirmacion').classList.add('activo');
        }

        async function eliminarQuiz(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`, { method: 'DELETE' });
                if (respuesta.ok) {
                    alert('‚úÖ Quiz eliminado');
                    cerrarModal('modalConfirmacion');
                    cargarQuizzes();
                } else {
                    alert('‚ùå Error eliminando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        function confirmarAccion() {
            if (callbackConfirmacion) {
                callbackConfirmacion();
                callbackConfirmacion = null;
            }
        }

        function cerrarModal(idModal) {
            document.getElementById(idModal).classList.remove('activo');
        }

        document.getElementById('formularioQuiz').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!confirm('¬øDeseas guardar este quiz?')) {
                return;
            }

            const idQuiz = document.getElementById('idQuiz').value;
            const modo = document.getElementById('modo').value;
            const datosQuiz = {
                titulo: document.getElementById('titulo').value,
                descripcion: document.getElementById('descripcion').value,
                modo: modo,
                num_grupos: modo === 'grupal' ? parseInt(document.getElementById('numGrupos').value) : 0,
                es_publico: document.getElementById('esPublico').checked
            };

            try {
                const url = idQuiz ? `/api/quizzes/${idQuiz}` : '/api/quizzes';
                const metodo = idQuiz ? 'PUT' : 'POST';
                const respuesta = await fetch(url, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosQuiz)
                });

                const datos = await respuesta.json();
                if (respuesta.ok) {
                    alert('‚úÖ Quiz guardado exitosamente');
                    cerrarModal('modalQuiz');
                    cargarQuizzes();
                    // ‚úÖ CORREGIDO: Usar 'id_quiz' (no 'quiz_id')
                    if (!idQuiz && datos.id_quiz) {
                        if (confirm('¬øDeseas agregar preguntas ahora?')) {
                            gestionarPreguntas(datos.id_quiz);
                        }
                    }
                } else {
                    alert('‚ùå Error guardando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        });

        async function cargarSesionesActivas() {
            try {
                const respuesta = await fetch('/api/sesiones_activas');
                const sesiones = await respuesta.json();

                const seccion = document.getElementById('seccionSesionesActivas');
                const contenedor = document.getElementById('contenedorSesionesActivas');

                if (sesiones.length === 0) {
                    seccion.style.display = 'none';
                    document.getElementById('totalparticipantes').textContent = 0;
                    return;
                }

                const totalParticipantes = sesiones.reduce((acum, s) => acum + (s.participant_count || 0), 0);
                document.getElementById('totalparticipantes').textContent = totalParticipantes;

                seccion.style.display = 'block';
                contenedor.innerHTML = sesiones.map(sesion => `
                    <div class="tarjeta-sesion ${sesion.estado}">
                        <div class="encabezado-sesion">
                            <div class="titulo-sesion">${sesion.titulo}</div>
                            <div class="estado-sesion ${sesion.estado}">
                                ${sesion.estado === 'esperando' ? '‚è≥ Esperando' :
                        sesion.estado === 'iniciada' ? '‚úÖ Iniciado' : 'üèÅ Finalizado'}
                            </div>
                        </div>
                        <div class="info-sesion">
                            <span>üìå PIN: <strong>${sesion.codigo_pin}</strong></span>
                            <span>üë• Participantes: <strong>${sesion.participant_count}</strong></span>
                            <span>üïí ${new Date(sesion.inicio_en_servidor).toLocaleString()}</span>
                        </div>
                        ${sesion.estado === 'iniciada' ? `
                            <div style="background: #fff3cd; padding: 12px; border-radius: 10px; margin: 10px 0; font-weight: bold; color: #856404; text-align: center;">
                                <span id="temporizador-${sesion.sesion_id}">‚è≥ Queda: --:--</span>
                            </div>
                        ` : ''}

                        ${sesion.estado === 'esperando' ? `
                            <div style="margin:8px 0; display:flex; gap:8px; align-items:center; justify-content:center;">
                                <label for="intentos-${sesion.sesion_id}" style="color:#333; font-weight:700; margin-right:8px;">Intentos:</label>
                                <input id="intentos-${sesion.sesion_id}" type="number" min="0" value="${sesion.intentos_restantes || 0}" style="width:80px; padding:8px; border-radius:8px; border:1px solid #ddd;">
                                <button class="boton-iniciar-quiz" onclick="iniciarSesionQuiz(${sesion.sesion_id})" style="margin-left:6px;">
                                    üöÄ INICIAR QUIZ
                                </button>
                            </div>
                        ` : sesion.estado === 'iniciada' ? `
                            <div style="display: flex; gap: 10px;">
                                <p style="color: #4caf50; font-weight: bold; flex: 1;">‚úÖ Quiz en progreso</p>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; margin-top: 10px;">
                                <button class="boton-iniciar-quiz" style="background: #6c63ff; width: auto; padding: 8px 20px; font-size: 0.9em;"
                                    onclick="window.open('/ver_sala_juego/${sesion.sesion_id}', '_blank')">
                                    üëÅÔ∏è Ver como anfitri√≥n
                                </button>
                                <button class="boton-iniciar-quiz" style="background: #f44336; width: auto; padding: 8px 20px; font-size: 0.9em;" onclick="finalizarSesionQuiz(${sesion.sesion_id})">
                                    ‚õî Finalizar Ahora
                                </button>
                            </div>
                        ` : `
                            <p style="color: #999; font-weight: bold;">üèÅ Quiz finalizado</p>
                        `}
                    </div>
                `).join('');

                sesiones.forEach(s => {
                    if (s.estado === 'iniciada' && window.temporizadoresSesion && window.temporizadoresSesion[s.sesion_id]) {
                        actualizarVisualizacionTemporizador(s.sesion_id);
                    }
                });
            } catch (error) {
                console.error('Error cargando sesiones activas:', error);
            }
        }

        window.temporizadoresSesion = window.temporizadoresSesion || {};

        function iniciarTemporizadorLocal(idSesion, minutos) {
            const mins = parseInt(minutos, 10);
            if (isNaN(mins) || mins <= 0) return;
            window.temporizadoresSesion[idSesion] = Date.now() + (mins * 60 * 1000);
            actualizarVisualizacionTemporizador(idSesion);
        }

        function actualizarVisualizacionTemporizador(idSesion) {
            const elemento = document.getElementById(`temporizador-${idSesion}`);
            if (!elemento) return;
            const fin = window.temporizadoresSesion[idSesion];
            if (!fin) {
                elemento.textContent = '‚è≥ Queda: --:--';
                return;
            }
            const restante = Math.max(0, fin - Date.now());
            const mm = String(Math.floor(restante / 60000)).padStart(2, '0');
            const ss = String(Math.floor((restante % 60000) / 1000)).padStart(2, '0');
            elemento.textContent = `‚è≥ Queda: ${mm}:${ss}`;
            if (restante === 0) {
                finalizarSesionQuiz(idSesion, true);
            }
        }

        setInterval(() => {
            Object.keys(window.temporizadoresSesion).forEach(idSesion => {
                actualizarVisualizacionTemporizador(idSesion);
            });
        }, 1000);

        async function iniciarSesionQuiz(idSesion) {
            const intentos = document.getElementById(`intentos-${idSesion}`).value;
            if (!confirm(`¬øIniciar el quiz con ${intentos} intentos?`)) return;
            try {
                // ‚úÖ CORREGIDO: Enviar 'intentos' (no 'intentos_restantes')
                const respuesta = await fetch(`/api/sesion/${idSesion}/iniciar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ intentos: parseInt(intentos) })
                });
                if (respuesta.ok) {
                    alert('‚úÖ Quiz iniciado');
                    cargarSesionesActivas();
                } else {
                    alert('‚ùå Error iniciando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function finalizarSesionQuiz(idSesion, automatico = false) {
            if (!automatico && !confirm('¬øFinalizar el quiz ahora? Los participantes no podr√°n continuar.')) return;
            try {
                const respuesta = await fetch(`/api/sesion/${idSesion}/finalizar`, { method: 'POST' });
                if (respuesta.ok) {
                    if (!automatico) alert('‚úÖ Quiz finalizado');
                    delete window.temporizadoresSesion[idSesion];
                    cargarSesionesActivas();
                } else {
                    alert('‚ùå Error finalizando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        // ‚úÖ INICIALIZACI√ìN CORREGIDA
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üöÄ Inicializando Panel de Profesor...');

            // ‚úÖ PASO 1: Verificar autenticaci√≥n
            const autenticado = await cargarInfoUsuario();

            if (!autenticado) {
                console.error('‚ùå Usuario no autenticado o no es profesor');
                return;
            }

            // ‚úÖ PASO 2: Cargar datos solo si est√° autenticado
            console.log('‚úÖ Cargando quizzes y sesiones...');
            cargarQuizzes();
            cargarSesionesActivas();

            // ‚úÖ PASO 3: Actualizar peri√≥dicamente
            setInterval(cargarSesionesActivas, 5000);
        });
    </script>


</body>

</html>