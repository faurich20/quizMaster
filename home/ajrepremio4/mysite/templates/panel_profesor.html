<!-- templates/panel_profesor.html -->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - QuizPlatform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .barra-navegacion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .barra-navegacion h1 {
            font-size: 1.8em;
        }

        .derecha-navegacion {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .boton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .boton:hover {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .boton-principal {
            background: white;
            color: #667eea;
        }

        .boton-principal:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .contenedor {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .cuadricula-estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tarjeta-estadistica {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .icono-estadistica {
            font-size: 3em;
        }

        .info-estadistica h3 {
            color: #333;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .info-estadistica p {
            color: #666;
        }

        .encabezado-seccion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .encabezado-seccion h2 {
            color: #333;
            font-size: 2em;
        }

        .cuadricula-quizzes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .tarjeta-quiz {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tarjeta-quiz:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .tarjeta-quiz h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .tarjeta-quiz p {
            color: #666;
            margin-bottom: 15px;
        }

        .meta-quiz {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #999;
        }

        .codigo-pin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .acciones-quiz {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .boton-pequeno {
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .boton-editar {
            background: #4caf50;
            color: white;
        }

        .boton-editar:hover {
            background: #45a049;
        }

        .boton-compartir {
            background: #2196f3;
            color: white;
        }

        .boton-compartir:hover {
            background: #0d8bf2;
        }

        .boton-eliminar {
            background: #f44336;
            color: white;
        }

        .boton-eliminar:hover {
            background: #da190b;
        }

        .boton-duplicar {
            background: #ff9800;
            color: white;
        }

        .boton-duplicar:hover {
            background: #e68900;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.activo {
            display: flex;
        }

        .contenido-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .encabezado-modal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .encabezado-modal h2 {
            color: #333;
        }

        .boton-cerrar {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }

        .boton-cerrar:hover {
            color: #333;
        }

        .grupo-formulario {
            margin-bottom: 20px;
        }

        .grupo-formulario label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .grupo-formulario input,
        .grupo-formulario textarea,
        .grupo-formulario select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
        }

        .grupo-formulario textarea {
            resize: vertical;
            min-height: 100px;
        }

        .grupo-casilla-verificacion {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grupo-casilla-verificacion input {
            width: auto;
        }

        .estado-vacio {
            text-align: center;
            padding: 60px 20px;
        }

        .icono-estado-vacio {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .estado-vacio h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .estado-vacio p {
            color: #999;
            margin-bottom: 20px;
        }

        .dialogo-confirmacion {
            text-align: center;
        }

        .dialogo-confirmacion h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .dialogo-confirmacion p {
            color: #666;
            margin-bottom: 30px;
        }

        .acciones-confirmacion {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .boton-confirmar {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
        }

        .boton-si {
            background: #f44336;
            color: white;
        }

        .boton-no {
            background: #e0e0e0;
            color: #333;
        }

        .tarjeta-sesion {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border-left: 5px solid #4caf50;
        }

        .tarjeta-sesion.esperando {
            border-left-color: #ff9800;
        }

        .tarjeta-sesion.iniciada {
            border-left-color: #4caf50;
        }

        .encabezado-sesion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .titulo-sesion {
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
        }

        .estado-sesion {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .estado-sesion.esperando {
            background: #fff3cd;
            color: #856404;
        }

        .estado-sesion.iniciada {
            background: #d4edda;
            color: #155724;
        }

        .info-sesion {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: #666;
        }

        .info-sesion span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .boton-iniciar-quiz {
            background: #4caf50;
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .boton-iniciar-quiz:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .boton-iniciar-quiz:deshabilitado {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>

<body>
    <div class="barra-navegacion">
        <h1>üéØ QuizPlatform</h1>
        <div class="derecha-navegacion">
            <span>Bienvenido, <strong id="nombreUsuario"></strong></span>
            <button class="boton boton-principal" onclick="abrirModalCrear()">+ Crear Quiz</button>
            <a href="/cerrar_sesion" class="boton">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="contenedor">
        <div class="cuadricula-estadisticas">
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üìö</div>
                <div class="info-estadistica">
                    <h3 id="totalQuizzes">0</h3>
                    <p>Quizzes Creados</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üéÆ</div>
                <div class="info-estadistica">
                    <h3 id="totalGames">0</h3>
                    <p>Partidas Jugadas</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üë•</div>
                <div class="info-estadistica">
                    <h3 id="totalparticipantes">0</h3>
                    <p>Participantes</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">‚≠ê</div>
                <div class="info-estadistica">
                    <h3 id="totalPublic">0</h3>
                    <p>Quizzes P√∫blicos</p>
                </div>
            </div>
        </div>

        <!-- Sesiones Activas (Modo Grupal) -->
        <div id="seccionSesionesActivas" style="display: none; margin-bottom: 30px;">
            <div class="encabezado-seccion">
                <h2>üéÆ Sesiones Grupales Activas</h2>
            </div>
            <div id="contenedorSesionesActivas"></div>
        </div>

        <div class="encabezado-seccion">
            <h2 id="tituloQuizzes">Todos los Quizzes</h2>
            <div>
                <button class="boton" onclick="cargarQuizzes('todos')">Todos</button>
                <button class="boton" onclick="cargarQuizzes('mios')">M√≠os</button>
            </div>
        </div>

        <div id="contenedorQuizzes"></div>
    </div>

    <!-- Modal Crear/Editar Quiz -->
    <div class="modal" id="modalQuiz">
        <div class="contenido-modal">
            <div class="encabezado-modal">
                <h2 id="tituloModal">Crear Nuevo Quiz</h2>
                <button class="boton-cerrar" onclick="cerrarModal('modalQuiz')">&times;</button>
            </div>
            <form id="formularioQuiz">
                <input type="hidden" id="idQuiz">
                <div class="grupo-formulario">
                    <label for="titulo">T√≠tulo del Quiz:</label>
                    <input type="text" id="titulo" required>
                </div>
                <div class="grupo-formulario">
                    <label for="descripcion">Descripci√≥n:</label>
                    <textarea id="descripcion"></textarea>
                </div>
                <div class="grupo-formulario">
                    <label for="modo">Modo de Juego:</label>
                    <select id="modo" onchange="alternarEntradaGrupos()">
                        <option value="individual">Individual</option>
                        <option value="grupal">Grupal</option>
                    </select>
                </div>
                <div class="grupo-formulario" id="contenedorNumGrupos" style="display: none;">
                    <label for="numGrupos">N√∫mero de Grupos:</label>
                    <input type="number" id="numGrupos" min="2" max="20" value="4">
                </div>
                <div class="grupo-formulario">
                    <label for="tiempoCuentaRegresiva">Tiempo por pregunta (segundos):</label>
                    <input type="number" id="tiempoCuentaRegresiva" min="10" max="120" value="30">
                </div>
                <div class="grupo-formulario">
                    <div class="grupo-casilla-verificacion">
                        <input type="checkbox" id="esPublico" checked>
                        <label for="esPublico">Hacer p√∫blico (otros usuarios pueden usarlo)</label>
                    </div>
                </div>
                <button type="submit" class="boton">Guardar Quiz</button>
            </form>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n -->
    <div class="modal" id="modalConfirmacion">
        <div class="contenido-modal">
            <div class="dialogo-confirmacion">
                <h3 id="tituloConfirmacion">¬øEst√°s seguro?</h3>
                <p id="mensajeConfirmacion">Esta acci√≥n no se puede deshacer.</p>
                <div class="acciones-confirmacion">
                    <button class="boton-confirmar boton-si" onclick="confirmarAccion()">S√≠, continuar</button>
                    <button class="boton-confirmar boton-no" onclick="cerrarModal('modalConfirmacion')">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let idQuizActual = null;
        let callbackConfirmacion = null;

        async function cargarQuizzes(filtro = 'todos') {
            try {
                const respuesta = await fetch('/api/quizzes');
                const quizzes = await respuesta.json();
                const contenedor = document.getElementById('contenedorQuizzes');
                const elementoTitulo = document.getElementById('tituloQuizzes');
                // T√≠tulo din√°mico seg√∫n filtro
                elementoTitulo.textContent = (filtro === 'mios') ? 'Mis Quizzes' : 'Todos los Quizzes';

                if (quizzes.length === 0) {
                    contenedor.innerHTML = `<div class="estado-vacio"><div class="icono-estado-vacio">üìù</div><h3>No tienes quizzes a√∫n</h3><p>Crea tu primer quiz para empezar</p><button class="boton" onclick="abrirModalCrear()">Crear Quiz</button></div>`;
                    return;
                }

                // Aplicar filtros
                let quizzesFiltrados = quizzes;
                if (filtro === 'mios') {
                    quizzesFiltrados = quizzes.filter(q => q.id_profesor == obtenerIdUsuarioActual());
                }

                // Verificar si hay resultados despu√©s del filtro
                if (quizzesFiltrados.length === 0) {
                    const nombreFiltro = filtro === 'mios' ? 'tuyos' : '';
                    contenedor.innerHTML = `<div class=\"estado-vacio\"><div class=\"icono-estado-vacio\">üîç</div><h3>No hay quizzes ${nombreFiltro}</h3><p>Intenta con otro filtro o crea un nuevo quiz</p><button class=\"boton\" onclick=\"cargarQuizzes('todos')\">Ver Todos</button></div>`;
                    return;
                }

                contenedor.innerHTML = '<div class="cuadricula-quizzes">' + quizzesFiltrados.map(quiz => `
                        <div class="tarjeta-quiz">
                            <h3>${quiz.titulo}</h3>
                            <p>${quiz.descripcion || 'Sin descripci√≥n'}</p>
                            <div class="meta-quiz">
                                <span>üéÆ ${quiz.modo === 'grupal' ? 'Grupal' : 'Individual'}</span>
                                <span>‚è±Ô∏è ${quiz.tiempo_cuenta_regresiva}s</span>
                                <span>${quiz.es_publico ? 'üåê P√∫blico' : 'üîí Privado'}</span>
                            </div>
                            <div class="codigo-pin">PIN: ${quiz.codigo_pin}</div>
                            <div class="acciones-quiz" style="margin-top: 15px;">
                                ${quiz.id_profesor == obtenerIdUsuarioActual() ? `
                                <button class="boton-pequeno boton-editar" onclick="editarQuiz(${quiz.id})">‚úèÔ∏è Editar</button>
                                <button class="boton-pequeno boton-editar" onclick="gestionarPreguntas(${quiz.id})">üìù Preguntas</button>
                                ` : `
                                <button class="boton-pequeno boton-editar" onclick="gestionarPreguntas(${quiz.id})">üìù Preguntas</button>
                                `}
                                <button class="boton-pequeno boton-compartir" onclick="compartirQuiz('${quiz.codigo_pin}')">üîó Compartir</button>
                                <button class="boton-pequeno boton-duplicar" onclick="duplicarQuiz(${quiz.id})">üìã Duplicar</button>
                                ${quiz.id_profesor == obtenerIdUsuarioActual() ? `
                                <button class="boton-pequeno boton-eliminar" onclick="confirmarEliminarQuiz(${quiz.id})">üóëÔ∏è Eliminar</button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('') + '</div>';
                actualizarEstadisticas(quizzes);
            } catch (error) { console.error('Error cargando quizzes:', error); }
        }

        function actualizarEstadisticas(quizzes) {
            // Quizzes Creados: solo los del profesor actual
            const misQuizzes = quizzes.filter(q => q.id_profesor == obtenerIdUsuarioActual());
            document.getElementById('totalQuizzes').textContent = misQuizzes.length;
            // Quizzes P√∫blicos: todos los p√∫blicos del sistema (de la respuesta actual)
            document.getElementById('totalPublic').textContent = quizzes.filter(q => q.es_publico).length;
        }

        function alternarEntradaGrupos() {
            const modo = document.getElementById('modo').value;
            const contenedor = document.getElementById('contenedorNumGrupos');
            contenedor.style.display = modo === 'grupal' ? 'block' : 'none';
        }

        function abrirModalCrear() {
            document.getElementById('tituloModal').textContent = 'Crear Nuevo Quiz';
            document.getElementById('formularioQuiz').reset(); document.getElementById('idQuiz').value = '';
            alternarEntradaGrupos(); // Resetear visibilidad
            document.getElementById('modalQuiz').classList.add('activo');
        }

        async function editarQuiz(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                document.getElementById('tituloModal').textContent = 'Editar Quiz';
                document.getElementById('idQuiz').value = quiz.id;
                document.getElementById('titulo').value = quiz.titulo;
                document.getElementById('descripcion').value = quiz.descripcion || '';
                document.getElementById('modo').value = quiz.modo;
                document.getElementById('numGrupos').value = quiz.num_grupos || 4;
                document.getElementById('tiempoCuentaRegresiva').value = quiz.tiempo_cuenta_regresiva;
                document.getElementById('esPublico').checked = quiz.es_publico;
                alternarEntradaGrupos();
                document.getElementById('modalQuiz').classList.add('activo');
            } catch (error) { alert('Error cargando el quiz'); }
        }

        function gestionarPreguntas(idQuiz) { window.location.href = `/editor_quiz/${idQuiz}`; }

        function compartirQuiz(codigoPin) {
            const url = `${window.location.origin}/quiz/${codigoPin}`;
            navigator.clipboard.writeText(url).then(() => {
                alert(`‚úÖ Enlace copiado al portapapeles:\n${url}\n\nPIN: ${codigoPin}`);
            });
        }

        async function duplicarQuiz(idQuiz) {
            if (!confirm('¬øDeseas duplicar este quiz y sus preguntas?')) return;
            try {
                // 1) Obtener quiz original con preguntas y opciones
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                if (!quiz || !quiz.id) { alert('No se pudo cargar el quiz original'); return; }

                // 2) Crear nuevo quiz perteneciente al usuario actual (esPublico=false por defecto)
                const nuevoQuiz = {
                    titulo: quiz.titulo + ' (Copia)',
                    descripcion: quiz.descripcion,
                    modo: quiz.modo,
                    num_grupos: quiz.num_grupos || 0,
                    tiempo_cuenta_regresiva: quiz.tiempo_cuenta_regresiva,
                    es_publico: false
                };
                const respuestaCrear = await fetch('/api/quizzes', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(nuevoQuiz)
                });
                const creado = await respuestaCrear.json();
                if (!respuestaCrear.ok || !creado.quiz_id) { alert('No se pudo crear la copia'); return; }
                const nuevoIdQuiz = creado.quiz_id;

                // 3) Copiar preguntas y opciones al nuevo quiz (una por una)
                const preguntas = quiz.preguntas || [];
                for (const p of preguntas) {
                    const cargaUtil = {
                        texto_pregunta: p.texto_pregunta,
                        url_imagen: p.url_imagen,
                        url_video: p.url_video,
                        tiempo_limite: p.tiempo_limite,
                        posicion: p.posicion || 0,
                        opciones: (p.opciones || []).map(o => ({ text: o.texto_opcion, es_correcta: !!o.es_correcta }))
                    };
                    await fetch(`/api/quizzes/${nuevoIdQuiz}/preguntas`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cargaUtil)
                    });
                }

                alert('‚úÖ Quiz duplicado exitosamente con sus preguntas');
                // Opcional: ir directo al editor de preguntas del nuevo quiz
                if (confirm('¬øDeseas abrir el editor de preguntas de la copia?')) {
                    gestionarPreguntas(nuevoIdQuiz);
                } else {
                    cargarQuizzes();
                }
            } catch (error) {
                console.error(error);
                alert('Error duplicando el quiz');
            }
        }

        function confirmarEliminarQuiz(idQuiz) {
            document.getElementById('tituloConfirmacion').textContent = '¬øEliminar Quiz?';
            document.getElementById('mensajeConfirmacion').textContent = 'Esta acci√≥n eliminar√° el quiz y todas sus preguntas. No se puede deshacer.';
            callbackConfirmacion = () => eliminarQuiz(idQuiz);
            document.getElementById('modalConfirmacion').classList.add('activo');
        }

        async function eliminarQuiz(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`, { method: 'DELETE' });
                if (respuesta.ok) {
                    alert('‚úÖ Quiz eliminado');
                    cerrarModal('modalConfirmacion');
                    cargarQuizzes();
                } else {
                    alert('‚ùå Error eliminando el quiz');
                }
            } catch (error) { alert('Error de conexi√≥n'); }
        }

        function confirmarAccion() { if (callbackConfirmacion) { callbackConfirmacion(); callbackConfirmacion = null; } }

        function cerrarModal(idModal) { document.getElementById(idModal).classList.remove('activo'); }

        document.getElementById('formularioQuiz').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!confirm('¬øDeseas guardar este quiz?')) { return; }
            const idQuiz = document.getElementById('idQuiz').value;
            const modo = document.getElementById('modo').value;
            const datosQuiz = {
                titulo: document.getElementById('titulo').value,
                descripcion: document.getElementById('descripcion').value,
                modo: modo,
                num_grupos: modo === 'grupal' ? parseInt(document.getElementById('numGrupos').value) : 0,
                tiempo_cuenta_regresiva: parseInt(document.getElementById('tiempoCuentaRegresiva').value),
                es_publico: document.getElementById('esPublico').checked
            };
            try {
                const url = idQuiz ? `/api/quizzes/${idQuiz}` : '/api/quizzes';
                const metodo = idQuiz ? 'PUT' : 'POST';
                const respuesta = await fetch(url, { method: metodo, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(datosQuiz) });
                const datos = await respuesta.json();
                if (respuesta.ok) {
                    alert('‚úÖ Quiz guardado exitosamente');
                    cerrarModal('modalQuiz');
                    cargarQuizzes();
                    if (!idQuiz && datos.quiz_id) {
                        if (confirm('¬øDeseas agregar preguntas ahora?')) {
                            gestionarPreguntas(datos.quiz_id);
                        }
                    }
                } else {
                    alert('‚ùå Error guardando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        });

        let idUsuarioActual = null;

        function obtenerIdUsuarioActual() { return idUsuarioActual; }

        // Cargar sesiones activas (modo grupal)
        async function cargarSesionesActivas() {
            try {
                const respuesta = await fetch('/api/sesiones_activas');
                const sesiones = await respuesta.json();

                const seccion = document.getElementById('seccionSesionesActivas');
                const contenedor = document.getElementById('contenedorSesionesActivas');

                if (sesiones.length === 0) {
                    seccion.style.display = 'none';
                    // Participantes: 0 si no hay sesiones activas
                    document.getElementById('totalparticipantes').textContent = 0;
                    return;
                }

                // Participantes en tiempo real: suma de participant_count de todas las sesiones activas del profesor
                const totalParticipantes = sesiones.reduce((acum, s) => acum + (s.participant_count || 0), 0);
                document.getElementById('totalparticipantes').textContent = totalParticipantes;

                seccion.style.display = 'block';
                contenedor.innerHTML = sesiones.map(sesion => `
                    <div class="tarjeta-sesion ${sesion.estado}">
                        <div class="encabezado-sesion">
                            <div class="titulo-sesion">${sesion.titulo}</div>
                            <div class="estado-sesion ${sesion.estado}">
                                ${sesion.estado === 'waiting' ? '‚è≥ Esperando' :sesiones_juego.estado === 'started' ? '‚úÖ Iniciado' : 'üèÅ Finalizado'}                           
                            </div>
                        </div>
                        <div class="info-sesion">
                            <span>üìå PIN: <strong>${sesion.codigo_pin}</strong></span>
                            <span>üë• Participantes: <strong>${sesion.participant_count}</strong></span>
                            <span>üïí ${new Date(sesion.inicio_en_servidor).toLocaleString()}</span>
                        </div>
                        ${sesion.estado === 'started' ? `
                            <div style="background: #fff3cd; padding: 12px; border-radius: 10px; margin: 10px 0; font-weight: bold; color: #856404; text-align: center;">
                                <span id="temporizador-${sesion.sesion_id}">‚è≥ Queda: --:--</span>
                            </div>
                        ` : ''}

                        ${sesion.estado === 'waiting' ? `
                            <div style="margin:8px 0; display:flex; gap:8px; align-items:center; justify-content:center;">
                                <label for="intentos-${sesion.sesion_id}" style="color:#333; font-weight:700; margin-right:8px;">Intentos:</label>
                                <input id="intentos-${sesion.sesion_id}" type="number" min="0" value="${sesion.intentos_restantes ?sesiones_juego.intentos_restantes : 0}" style="width:80px; padding:8px; border-radius:8px; border:1px solid #ddd;">
                                <button class="boton-iniciar-quiz" onclick="iniciarSesionQuiz(${sesion.sesion_id})" style="margin-left:6px;">
                                    üöÄ INICIAR QUIZ
                                </button>
                            </div>

                        ` :sesiones_juego.estado === 'started' ? `
                            <div style="display: flex; gap: 10px;">
                                <p style="color: #4caf50; font-weight: bold; flex: 1;">‚úÖ Quiz en progreso</p>                     
                            </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; margin-top: 10px;">
                                <button class="boton-iniciar-quiz" style="background: #6c63ff; width: auto; padding: 8px 20px; font-size: 0.9em;"
                                    onclick="window.open('/ver_sala_juego/${sesion.sesion_id}', '_blank')">
                                    üëÅÔ∏è Ver como anfitri√≥n
                                </button>
                                <button class="boton-iniciar-quiz" style="background: #f44336; width: auto; padding: 8px 20px; font-size: 0.9em;" onclick="finalizarSesionQuiz(${sesion.sesion_id})">
                                    ‚õî Finalizar Ahora
                                </button>   
                            </div>

                        ` : `
                            <p style="color: #999; font-weight: bold;">üèÅ Quiz finalizado</p>
                        `}
                    </div>
                `).join('');

                // IMPORTANTE: Despu√©s de renderizar, re-activar los temporizadores existentes
                sesiones.forEach(s => {
                    if (s.estado === 'started' && window.temporizadoresSesion && window.temporizadoresSesion[s.sesion_id]) {
                        actualizarVisualizacionTemporizador(s.sesion_id);
                    }
                });

                // Re-activar temporizadores en DOM si existen en memoria despu√©s de render
                sesiones.forEach(s => { if (s.estado === 'started' && window.temporizadoresSesion && window.temporizadoresSesion[s.sesion_id]) { actualizarVisualizacionTemporizador(s.sesion_id); } });
            } catch (error) {
                console.error('Error cargando sesiones activas:', error);
            }
        }

        // Gesti√≥n de temporizadores locales
        window.temporizadoresSesion = window.temporizadoresSesion || {}; // { sessionId: msEpochEnds }
        function iniciarTemporizadorLocal(idSesion, minutos) {
            const mins = parseInt(minutos, 10);
            if (isNaN(mins) || mins <= 0) return;
            window.temporizadoresSesion[idSesion] = Date.now() + (mins * 60 * 1000);
            actualizarVisualizacionTemporizador(idSesion);
        }

        function actualizarVisualizacionTemporizador(idSesion) {
            const elemento = document.getElementById(`temporizador-${idSesion}`);
            if (!elemento) return;
            const fin = window.temporizadoresSesion[idSesion];
            if (!fin) { elemento.textContent = '‚è≥ Queda: --:--'; return; }
            const restante = Math.max(0, fin - Date.now());
            const mm = String(Math.floor(restante / 60000)).padStart(2, '0');
            const ss = String(Math.floor((restante % 60000) / 1000)).padStart(2, '0');
            elemento.textContent = `‚è≥ Queda: ${mm}:${ss}`;
            if (restante === 0) {
                // Auto-finalizar (sin confirmaci√≥n)
                finalizarSesionQuiz(idSesion, true);
            }
        }

        setInterval(() => {
            Object.keys(window.temporizadoresSesion).forEach(idSesion => {
                actualizarVisualizacionTemporizador(idSesion);
            });
        }, 1000);

        async function iniciarSesionQuiz(idSesion) {
            const intentos = document.getElementById(`intentos-${idSesion}`).value;
            if (!confirm(`¬øIniciar el quiz con ${intentos} intentos?`)) return;
            try {
                const respuesta = await fetch(`/api/sessions/${idSesion}/iniciar`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ intentos_restantes: parseInt(intentos) })
                });
                if (respuesta.ok) {
                    alert('‚úÖ Quiz iniciado');
                    cargarSesionesActivas();
                } else {
                    alert('‚ùå Error iniciando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function finalizarSesionQuiz(idSesion, automatico = false) {
            if (!automatico && !confirm('¬øFinalizar el quiz ahora? Los participantes no podr√°n continuar.')) return;
            try {
                const respuesta = await fetch(`/api/sessions/${idSesion}/end`, { method: 'POST' });
                if (respuesta.ok) {
                    if (!automatico) alert('‚úÖ Quiz finalizado');
                    delete window.temporizadoresSesion[idSesion];
                    cargarSesionesActivas();
                } else {
                    alert('‚ùå Error finalizando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                const respuesta = await fetch('/api/usuarios');
                const usuario = await respuesta.json();
                if (usuario && usuario.name) {
                    document.getElementById('nombreUsuario').textContent = usuario.name;
                    idUsuarioActual = usuario.id;
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                window.location.href = '/';
            }
            cargarQuizzes();
            cargarSesionesActivas();
            setInterval(cargarSesionesActivas, 5000); // Actualizar cada 5 segundos
        });
    </script>
</body>

</html>