<!-- templates/panel_profesor.html CORREGIDO COMPLETO -->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - QuizPlatform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .barra-navegacion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .barra-navegacion h1 {
            font-size: 1.8em;
        }

        .derecha-navegacion {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .boton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .boton:hover {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .boton-principal {
            background: white;
            color: #667eea;
        }

        .boton-principal:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .contenedor {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .cuadricula-estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tarjeta-estadistica {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .icono-estadistica {
            font-size: 3em;
        }

        .info-estadistica h3 {
            color: #333;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .info-estadistica p {
            color: #666;
        }

        .encabezado-seccion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .encabezado-seccion h2 {
            color: #333;
            font-size: 2em;
        }

        .cuadricula-quizzes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .tarjeta-quiz {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tarjeta-quiz:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .tarjeta-quiz h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .tarjeta-quiz p {
            color: #666;
            margin-bottom: 15px;
        }

        .meta-quiz {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #999;
        }

        .codigo-pin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .acciones-quiz {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .boton-pequeno {
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .boton-editar {
            background: #4caf50;
            color: white;
        }

        .boton-editar:hover {
            background: #45a049;
        }

        .boton-proyectar {
            background: #2196f3;
            color: white;
        }

        .boton-proyectar:hover {
            background: #0d8bf2;
        }

        .boton-eliminar {
            background: #f44336;
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .boton-eliminar:hover {
            background: #da190b;
        }

        .boton-duplicar {
            background: #ff9800;
            color: white;
        }

        .boton-duplicar:hover {
            background: #e68900;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.activo {
            display: flex;
        }

        .contenido-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .encabezado-modal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .encabezado-modal h2 {
            color: #333;
        }

        .boton-cerrar {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }

        .boton-cerrar:hover {
            color: #333;
        }

        .grupo-formulario {
            margin-bottom: 20px;
        }

        .grupo-formulario label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .grupo-formulario input,
        .grupo-formulario textarea,
        .grupo-formulario select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
        }

        .grupo-formulario textarea {
            resize: vertical;
            min-height: 100px;
        }

        .grupo-casilla-verificacion {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grupo-casilla-verificacion input {
            width: auto;
        }

        .estado-vacio {
            text-align: center;
            padding: 60px 20px;
        }

        .icono-estado-vacio {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .estado-vacio h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .estado-vacio p {
            color: #999;
            margin-bottom: 20px;
        }

        .dialogo-confirmacion {
            text-align: center;
        }

        .dialogo-confirmacion h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .dialogo-confirmacion p {
            color: #666;
            margin-bottom: 30px;
        }

        .acciones-confirmacion {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .boton-confirmar {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
        }

        .boton-si {
            background: #f44336;
            color: white;
        }

        .boton-no {
            background: #e0e0e0;
            color: #333;
        }

        .tarjeta-sesion {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border-left: 5px solid #4caf50;
        }

        .tarjeta-sesion.esperando {
            border-left-color: #ff9800;
        }

        .tarjeta-sesion.iniciada {
            border-left-color: #4caf50;
        }

        .encabezado-sesion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .titulo-sesion {
            font-size: 1.3em;
            color: #333;
            font-weight: bold;
        }

        .estado-sesion {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
        }

        .estado-sesion.esperando {
            background: #fff3cd;
            color: #856404;
        }

        .estado-sesion.iniciada {
            background: #d4edda;
            color: #155724;
        }

        .info-sesion {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            color: #666;
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        .info-sesion span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .contenedor-participantes-tiempo-real {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .contenedor-participantes-tiempo-real h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .lista-participantes-tiempo-real {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .participante-chip {
            background: white;
            border: 2px solid #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #667eea;
            font-weight: 600;
        }

        .boton-iniciar-quiz {
            background: #4caf50;
            color: white;
            padding: 10px 25px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .boton-iniciar-quiz:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .boton-iniciar-quiz:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #modalProyectarQuiz .contenido-modal {
            max-width: 900px;
            background: linear-gradient(135deg, #ffffff, #f0f3ff);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
        }

        .info-pin-compartir {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
        }

        .info-pin-compartir h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .info-pin-compartir p {
            font-size: 1.1em;
            margin: 8px 0;
        }

        .info-pin-compartir .pin-grande {
            font-size: 2.5em;
            font-weight: 800;
            letter-spacing: 4px;
            margin: 15px 0;
        }

        .opcion {
            display: grid;
            grid-template-columns: 28px 1fr 44px;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .grupo-formulario .opcion input[type="text"] {
            width: 100% !important;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        .grupo-formulario .opcion input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
            cursor: pointer;
        }

        .opcion .boton-eliminar {
            min-width: 44px;
            height: 40px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .opcion-acciones {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        #modalImportarPreguntas .contenido-modal {
            max-height: 90vh;
            overflow-y: auto;
        }

        #modalImportarPreguntas ol {
            background: #f8f9fa;
            padding: 20px 20px 20px 40px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        #archivoExcelPreguntas:hover {
            background: #e8efff !important;
            border-color: #5568d3 !important;
        }

        #resultadoImportacion {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="barra-navegacion">
        <h1>üéØ QuizPlatform</h1>
        <div class="derecha-navegacion">
            <span>Bienvenido, <strong id="nombreUsuario"></strong></span>
            <button class="boton boton-principal" onclick="abrirModalCrear()">+ Crear Quiz</button>
            <a href="/cerrar_sesion" class="boton">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="contenedor">
        <div class="cuadricula-estadisticas">
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üìö</div>
                <div class="info-estadistica">
                    <h3 id="totalQuizzes">0</h3>
                    <p>Quizzes Creados</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üéÆ</div>
                <div class="info-estadistica">
                    <h3 id="totalGames">0</h3>
                    <p>Partidas Jugadas</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">üë•</div>
                <div class="info-estadistica">
                    <h3 id="totalparticipantes">0</h3>
                    <p>Participantes</p>
                </div>
            </div>
            <div class="tarjeta-estadistica">
                <div class="icono-estadistica">‚≠ê</div>
                <div class="info-estadistica">
                    <h3 id="totalPublic">0</h3>
                    <p>Quizzes P√∫blicos</p>
                </div>
            </div>
        </div>

        <div class="encabezado-seccion">
            <h2 id="tituloQuizzes">Todos los Quizzes</h2>
            <div>
                <button class="boton" onclick="cargarQuizzes('todos')">Todos</button>
                <button class="boton" onclick="cargarQuizzes('mios')">M√≠os</button>
            </div>
        </div>

        <div id="contenedorQuizzes"></div>
    </div>

    <!-- Modal Crear/Editar Quiz -->
    <div class="modal" id="modalQuiz">
        <div class="contenido-modal">
            <div class="encabezado-modal">
                <h2 id="tituloModal">Crear Nuevo Quiz</h2>
                <button class="boton-cerrar" onclick="cerrarModal('modalQuiz')">&times;</button>
            </div>
            <form id="formularioQuiz">
                <input type="hidden" id="idQuiz">
                <div class="grupo-formulario">
                    <label for="titulo">T√≠tulo del Quiz:</label>
                    <input type="text" id="titulo" required>
                </div>
                <div class="grupo-formulario">
                    <label for="descripcion">Descripci√≥n:</label>
                    <textarea id="descripcion"></textarea>
                </div>
                <div class="grupo-formulario">
                    <label for="modo">Modo de Juego:</label>
                    <select id="modo" onchange="alternarEntradaGrupos()">
                        <option value="individual">Individual</option>
                        <option value="grupal">Grupal</option>
                    </select>
                </div>
                <div class="grupo-formulario" id="contenedorNumGrupos" style="display: none;">
                    <label for="numGrupos">N√∫mero de Grupos:</label>
                    <input type="number" id="numGrupos" min="2" max="20" value="4">
                </div>
                <div class="grupo-formulario">
                    <div class="grupo-casilla-verificacion">
                        <input type="checkbox" id="esPublico" checked>
                        <label for="esPublico">Hacer p√∫blico (otros usuarios pueden usarlo)</label>
                    </div>
                </div>
                <button type="submit" class="boton">Guardar Quiz</button>
            </form>
        </div>
    </div>

    <!-- Modal Preguntas del Quiz -->
    <div class="modal" id="modalPreguntasQuiz">
        <div class="contenido-modal" style="max-width: 900px;">
            <div class="encabezado-modal">
                <h2>Preguntas del Quiz</h2>
                <button class="boton-cerrar" onclick="cerrarModal('modalPreguntasQuiz')">&times;</button>
            </div>

            <div id="listaPreguntas"></div>

            <div class="acciones-confirmacion" style="margin-top: 20px; gap: 10px;">
                <button class="boton" onclick="agregarPregunta()">‚ûï Nueva Pregunta</button>
                <button class="boton" style="background:#ff9800;" onclick="abrirImportarPreguntas()">üì• Importar</button>
                <button class="boton" style="background:#2196f3;" onclick="descargarPlantilla()">üìÑ Plantilla</button>
                <button class="boton" style="background:#4caf50;" onclick="guardarPreguntas()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Importar Preguntas -->
    <div class="modal" id="modalImportarPreguntas">
        <div class="contenido-modal" style="max-width: 600px;">
            <div class="encabezado-modal">
                <h2>üì• Importar Preguntas desde Excel</h2>
                <button class="boton-cerrar" onclick="cerrarModal('modalImportarPreguntas')">&times;</button>
            </div>

            <div style="padding: 20px; text-align: left;">
                <div class="grupo-formulario">
                    <label style="font-size: 1.1em; margin-bottom: 15px; display: block;">
                        <strong>Instrucciones:</strong>
                    </label>
                    <ol style="line-height: 2; color: #666; margin-left: 20px;">
                        <li>Descarga la plantilla Excel haciendo clic en <strong>"Descargar Plantilla"</strong></li>
                        <li>Completa las preguntas y opciones en el archivo</li>
                        <li>Aseg√∫rate de marcar con <strong>"SI"</strong> las respuestas correctas</li>
                        <li>Cada pregunta debe tener m√≠nimo 2 opciones</li>
                        <li>Sube el archivo completado usando el bot√≥n de abajo</li>
                    </ol>
                </div>

                <div class="grupo-formulario" style="margin-top: 30px;">
                    <label for="archivoExcelPreguntas" style="display: block; margin-bottom: 10px;">
                        <strong>Selecciona tu archivo Excel:</strong>
                    </label>
                    <input type="file" id="archivoExcelPreguntas" accept=".xlsx,.xls"
                        style="display: block; width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 10px; background: #f0f4ff; cursor: pointer;">
                </div>

                <div id="resultadoImportacion" style="margin-top: 20px; display: none;">
                    <div id="mensajeImportacion" style="padding: 15px; border-radius: 10px;"></div>
                </div>

                <div class="acciones-confirmacion" style="margin-top: 30px;">
                    <button class="boton" style="background:#2196f3;" onclick="descargarPlantilla()">
                        üìÑ Descargar Plantilla
                    </button>
                    <button class="boton" style="background:#4caf50;" onclick="procesarImportacion()">
                        üì• Importar Preguntas
                    </button>
                    <button class="boton boton-secundario" onclick="cerrarModal('modalImportarPreguntas')">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Proyectar Quiz -->
    <div class="modal" id="modalProyectarQuiz">
        <div class="contenido-modal">
            <div class="encabezado-modal">
                <h2>üéØ Proyectar Quiz</h2>
                <button class="boton-cerrar" onclick="cerrarModal('modalProyectarQuiz')">&times;</button>
            </div>

            <div class="info-pin-compartir">
                <h3>¬°Comparte tu Quiz!</h3>
                <p>Entra a:</p>
                <p style="font-weight: bold; font-size: 1.2em;" id="urlJugar"></p>
                <p style="margin-top: 15px;">PIN:</p>
                <p class="pin-grande" id="pinProyectar"></p>
            </div>

            <div id="contenedorSesionesActivas"></div>

            <button class="boton" onclick="cerrarModal('modalProyectarQuiz')" style="width: 100%; margin-top: 20px;">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n -->
    <div class="modal" id="modalConfirmacion">
        <div class="contenido-modal">
            <div class="dialogo-confirmacion">
                <h3 id="tituloConfirmacion">¬øEst√°s seguro?</h3>
                <p id="mensajeConfirmacion">Esta acci√≥n no se puede deshacer.</p>
                <div class="acciones-confirmacion">
                    <button class="boton-confirmar boton-si" onclick="confirmarAccion()">S√≠, continuar</button>
                    <button class="boton-confirmar boton-no" onclick="cerrarModal('modalConfirmacion')">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let idQuizActual = null;
        let callbackConfirmacion = null;
        let idUsuarioActual = null;
        let intervaloSesionesActivas = null;
        let quizActualProyectado = null;
        window.temporizadoresSesion = {};

        // ============================================================
        // ‚úÖ PERSISTENCIA EN LOCALSTORAGE
        // ============================================================
        function guardarTemporizadores() {
            try {
                localStorage.setItem('temporizadores_sesion', JSON.stringify(window.temporizadoresSesion));
                console.log('üíæ Temporizadores guardados en localStorage');
            } catch (e) {
                console.error('Error guardando temporizadores:', e);
            }
        }

        function restaurarTemporizadores() {
            try {
                const guardado = localStorage.getItem('temporizadores_sesion');
                if (guardado) {
                    const datos = JSON.parse(guardado);
                    // Filtrar timestamps obsoletos (m√°s de 2 horas en el pasado)
                    const ahora = Date.now();
                    Object.keys(datos).forEach(key => {
                        if (datos[key] > ahora - (2 * 60 * 60 * 1000)) {
                            window.temporizadoresSesion[key] = datos[key];
                        }
                    });
                    console.log('‚úÖ Temporizadores restaurados desde localStorage:', window.temporizadoresSesion);
                }
            } catch (e) {
                console.error('Error restaurando temporizadores:', e);
                window.temporizadoresSesion = {};
            }
        }

        // Restaurar al cargar la p√°gina
        restaurarTemporizadores();

        // Guardar cada vez que cambie (cada 3 segundos)
        setInterval(() => {
            if (Object.keys(window.temporizadoresSesion).length > 0) {
                guardarTemporizadores();
            }
        }, 3000);

        // ============================================================
        // FUNCIONES DE AUTENTICACI√ìN
        // ============================================================
        async function cargarInfoUsuario() {
            try {
                const respuesta = await fetch('/api/info_sesion');
                const datos = await respuesta.json();

                if (!datos.id_usuario) {
                    alert('‚ö†Ô∏è Sesi√≥n inv√°lida. Por favor inicia sesi√≥n nuevamente.');
                    window.location.href = '/iniciar_sesion';
                    return false;
                }

                if (!datos.es_profesor) {
                    alert('‚ö†Ô∏è Acceso denegado. Esta √°rea es solo para profesores.');
                    window.location.href = '/';
                    return false;
                }

                idUsuarioActual = datos.id_usuario;
                document.getElementById('nombreUsuario').textContent = datos.nombre_usuario || 'Profesor';

                return true;
            } catch (error) {
                console.error('‚ùå Error al cargar informaci√≥n del usuario:', error);
                alert('‚ö†Ô∏è Error de conexi√≥n. Por favor recarga la p√°gina.');
                window.location.href = '/iniciar_sesion';
                return false;
            }
        }

        // ============================================================
        // FUNCIONES DE QUIZZES
        // ============================================================
        async function cargarQuizzes(filtro = 'todos') {
            try {
                const respuesta = await fetch('/api/quizzes');
                const quizzes = await respuesta.json();
                const contenedor = document.getElementById('contenedorQuizzes');
                const elementoTitulo = document.getElementById('tituloQuizzes');

                elementoTitulo.textContent = (filtro === 'mios') ? 'Mis Quizzes' : 'Todos los Quizzes';

                if (quizzes.length === 0) {
                    contenedor.innerHTML = `<div class="estado-vacio"><div class="icono-estado-vacio">üìù</div><h3>No tienes quizzes a√∫n</h3><p>Crea tu primer quiz para empezar</p><button class="boton" onclick="abrirModalCrear()">Crear Quiz</button></div>`;
                    return;
                }

                let quizzesFiltrados = quizzes;
                if (filtro === 'mios') {
                    quizzesFiltrados = quizzes.filter(q => q.id_profesor == idUsuarioActual);
                }

                if (quizzesFiltrados.length === 0) {
                    const nombreFiltro = filtro === 'mios' ? 'tuyos' : '';
                    contenedor.innerHTML = `<div class="estado-vacio"><div class="icono-estado-vacio">üîç</div><h3>No hay quizzes ${nombreFiltro}</h3><p>Intenta con otro filtro o crea un nuevo quiz</p><button class="boton" onclick="cargarQuizzes('todos')">Ver Todos</button></div>`;
                    return;
                }

                contenedor.innerHTML = '<div class="cuadricula-quizzes">' + quizzesFiltrados.map(quiz => `
                    <div class="tarjeta-quiz">
                        <h3>${quiz.titulo}</h3>
                        <p>${quiz.descripcion || 'Sin descripci√≥n'}</p>
                        <div class="meta-quiz">
                            <span>üéÆ ${quiz.modo === 'grupal' ? 'Grupal' : 'Individual'}</span>
                            <span>${quiz.es_publico ? 'üåê P√∫blico' : 'üîí Privado'}</span>
                        </div>
                        <div class="codigo-pin">PIN: ${quiz.codigo_pin}</div>
                        <div class="acciones-quiz" style="margin-top: 15px;">
                            ${quiz.id_profesor == idUsuarioActual ? `
                            <button class="boton-pequeno boton-editar" onclick="editarQuiz(${quiz.id})">‚úèÔ∏è Editar</button>
                            <button class="boton-pequeno boton-editar" onclick="gestionarPreguntas(${quiz.id})">üìù Preguntas</button>
                            ` : `
                            <button class="boton-pequeno boton-editar" onclick="gestionarPreguntas(${quiz.id})">üìù Preguntas</button>
                            `}
                            <button class="boton-pequeno boton-proyectar" onclick="proyectarQuiz('${quiz.codigo_pin}', ${quiz.id})">üîó Proyectar</button>
                            <button class="boton-pequeno boton-duplicar" onclick="duplicarQuiz(${quiz.id})">üìã Duplicar</button>
                            ${quiz.id_profesor == idUsuarioActual ? `
                            <button class="boton-pequeno boton-eliminar" onclick="confirmarEliminarQuiz(${quiz.id})">üóëÔ∏è Eliminar</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('') + '</div>';

                actualizarEstadisticas(quizzes);
            } catch (error) {
                console.error('Error cargando quizzes:', error);
            }
        }

        function actualizarEstadisticas(quizzes) {
            const misQuizzes = quizzes.filter(q => q.id_profesor == idUsuarioActual);
            document.getElementById('totalQuizzes').textContent = misQuizzes.length;
            document.getElementById('totalPublic').textContent = quizzes.filter(q => q.es_publico).length;
        }

        function alternarEntradaGrupos() {
            const modo = document.getElementById('modo').value;
            const contenedor = document.getElementById('contenedorNumGrupos');
            contenedor.style.display = modo === 'grupal' ? 'block' : 'none';
        }

        function abrirModalCrear() {
            document.getElementById('tituloModal').textContent = 'Crear Nuevo Quiz';
            document.getElementById('formularioQuiz').reset();
            document.getElementById('idQuiz').value = '';
            alternarEntradaGrupos();
            document.getElementById('modalQuiz').classList.add('activo');
        }

        async function editarQuiz(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                document.getElementById('tituloModal').textContent = 'Editar Quiz';
                document.getElementById('idQuiz').value = quiz.id;
                document.getElementById('titulo').value = quiz.titulo;
                document.getElementById('descripcion').value = quiz.descripcion || '';
                document.getElementById('modo').value = quiz.modo;
                document.getElementById('numGrupos').value = quiz.num_grupos || 4;
                document.getElementById('esPublico').checked = quiz.es_publico;
                alternarEntradaGrupos();
                document.getElementById('modalQuiz').classList.add('activo');
            } catch (error) {
                alert('Error cargando el quiz');
            }
        }

        // ============================================================
        // ‚úÖ FUNCI√ìN PROYECTAR QUIZ MEJORADA CON RESTAURACI√ìN
        // ============================================================
        async function proyectarQuiz(codigoPin, idQuiz) {
            restaurarTemporizadores(); // ‚úÖ RESTAURAR ANTES DE ABRIR MODAL
            
            quizActualProyectado = idQuiz;
            const urlJuego = `${window.location.origin}/jugar`;
            
            document.getElementById('urlJugar').textContent = urlJuego;
            document.getElementById('pinProyectar').textContent = codigoPin;
            
            document.getElementById('modalProyectarQuiz').classList.add('activo');
            
            const textoPlano = `üéØ √önete a mi quiz!\n\nEntra a: ${urlJuego}\nPIN: ${codigoPin}`;
            navigator.clipboard.writeText(textoPlano).catch(() => {});
            
            // ‚úÖ CARGAR SESIONES ACTIVAS INMEDIATAMENTE
            await cargarSesionesActivasEnModal(idQuiz);
            
            // ‚úÖ INICIAR POLLING
            if (intervaloSesionesActivas) {
                clearInterval(intervaloSesionesActivas);
            }
            intervaloSesionesActivas = setInterval(() => {
                if (document.getElementById('modalProyectarQuiz').classList.contains('activo')) {
                    cargarSesionesActivasEnModal(idQuiz);
                }
            }, 5000);
        }

        // ============================================================
        // ‚úÖ CARGAR SESIONES ACTIVAS CON RESTAURACI√ìN COMPLETA
        // ============================================================
        async function cargarSesionesActivasEnModal(idQuiz) {
            try {
                const respuesta = await fetch('/api/sesiones_activas');
                const todasLasSesiones = await respuesta.json();
                
                const sesiones = todasLasSesiones.filter(s => s.quiz_id == idQuiz);
                
                const contenedor = document.getElementById('contenedorSesionesActivas');
                
                if (sesiones.length === 0) {
                    contenedor.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666; background: #f8f9fa; border-radius: 10px; margin-top: 20px;">
                            <p style="font-size: 1.1em;">‚è≥ Esperando participantes...</p>
                            <p style="font-size: 0.9em; margin-top: 5px;">Los participantes aparecer√°n aqu√≠ cuando se unan</p>
                        </div>
                    `;
                    return;
                }

                const totalParticipantes = sesiones.reduce((acum, s) => acum + (s.participant_count || 0), 0);
                document.getElementById('totalparticipantes').textContent = totalParticipantes;

                // ‚úÖ RESTAURAR TIMESTAMPS DESDE EL SERVIDOR SIEMPRE
                sesiones.forEach(sesion => {
                    if (sesion.estado === 'iniciada' && sesion.expira_temporizador) {
                        try {
                            const expiraStr = sesion.expira_temporizador.replace(' ', 'T');
                            const expiraDate = new Date(expiraStr);
                            
                            if (!isNaN(expiraDate.getTime())) {
                                const nuevoTimestamp = expiraDate.getTime();
                                
                                // ‚úÖ FORZAR ACTUALIZACI√ìN SIEMPRE
                                window.temporizadoresSesion[sesion.sesion_id] = nuevoTimestamp;
                                console.log('‚úÖ Temporizador configurado/restaurado:', sesion.sesion_id, new Date(nuevoTimestamp).toLocaleString());
                            } else {
                                console.error('‚ùå Fecha inv√°lida:', sesion.expira_temporizador);
                            }
                        } catch (e) {
                            console.error('‚ùå Error procesando expira_temporizador:', e);
                        }
                    }
                });

                const sesionesExistentes = contenedor.querySelectorAll('.tarjeta-sesion');
                const necesitaRegeneracion = sesionesExistentes.length !== sesiones.length;

                if (necesitaRegeneracion) {
                    contenedor.innerHTML = sesiones.map(sesion => {
                        return `
                            <div class="tarjeta-sesion ${sesion.estado}" data-sesion-id="${sesion.sesion_id}">
                                <div class="encabezado-sesion">
                                    <div class="titulo-sesion">${sesion.titulo}</div>
                                    <div class="estado-sesion ${sesion.estado}">
                                        ${sesion.estado === 'esperando' ? '‚è≥ Esperando' :
                                          sesion.estado === 'iniciada' ? '‚úÖ Iniciado' : 'üèÅ Finalizado'}
                                    </div>
                                </div>
                                <div class="info-sesion">
                                    <span>üìå PIN: <strong>${sesion.codigo_pin}</strong></span>
                                    <span>üë• Participantes: <strong id="count-${sesion.sesion_id}">${sesion.participant_count}</strong></span>
                                    <span>üïí ${new Date(sesion.inicio_en_servidor).toLocaleString()}</span>
                                </div>
                                
                                ${sesion.estado === 'iniciada' ? `
                                    <div style="background: #fff3cd; padding: 12px; border-radius: 10px; margin: 10px 0; font-weight: bold; color: #856404; text-align: center;">
                                        <span id="temporizador-${sesion.sesion_id}">‚è≥ Queda: --:--</span>
                                    </div>
                                ` : ''}

                                ${sesion.estado === 'esperando' ? `
                                    <div style="margin:12px 0; display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap: wrap;">
                                        <label for="intentos-${sesion.sesion_id}" style="color:#333; font-weight:700;">Intentos:</label>
                                        <input id="intentos-${sesion.sesion_id}" type="number" min="0" value="${sesion.intentos_restantes || 0}" 
                                            style="width:80px; padding:8px; border-radius:8px; border:1px solid #ddd;">
                                        <button class="boton-iniciar-quiz" onclick="iniciarSesionQuiz(${sesion.sesion_id})">
                                            üöÄ INICIAR QUIZ
                                        </button>
                                    </div>
                                ` : sesion.estado === 'iniciada' ? `
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <p style="color: #4caf50; font-weight: bold; flex: 1;">‚úÖ Quiz en progreso</p>
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; margin-top: 10px;">
                                        <button class="boton-iniciar-quiz" style="background: #6c63ff; width: auto; padding: 8px 20px; font-size: 0.9em;"
                                            onclick="window.open('/ver_sala_juego/${sesion.sesion_id}', '_blank')">
                                            üëÅÔ∏è Ver como anfitri√≥n
                                        </button>
                                        <button class="boton-iniciar-quiz" style="background: #f44336; width: auto; padding: 8px 20px; font-size: 0.9em;" 
                                            onclick="finalizarSesionQuiz(${sesion.sesion_id})">
                                            ‚õî Finalizar Ahora
                                        </button>
                                    </div>
                                ` : `
                                    <p style="color: #999; font-weight: bold;">üèÅ Quiz finalizado</p>
                                `}

                                <div id="participantes-sesion-${sesion.sesion_id}"></div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // ‚úÖ ACTUALIZAR CONTADORES
                    sesiones.forEach(sesion => {
                        const countElement = document.getElementById(`count-${sesion.sesion_id}`);
                        if (countElement) {
                            countElement.textContent = sesion.participant_count;
                        }
                    });
                }

                // ‚úÖ FORZAR ACTUALIZACI√ìN VISUAL INMEDIATA DE TODOS LOS TEMPORIZADORES
                sesiones.forEach(sesion => {
                    if (sesion.estado === 'iniciada') {
                        actualizarVisualizacionTemporizador(sesion.sesion_id);
                    }
                });

                sesiones.forEach(sesion => {
                    cargarParticipantesEnTiempoReal(sesion.sesion_id);
                });

            } catch (error) {
                console.error('Error cargando sesiones activas:', error);
            }
        }

        // ============================================================
        // ‚úÖ CARGAR PARTICIPANTES EN TIEMPO REAL
        // ============================================================
        async function cargarParticipantesEnTiempoReal(idSesion) {
            try {
                const respuesta = await fetch(`/api/sesion/${idSesion}/estado`);
                const datos = await respuesta.json();
                
                const contenedor = document.getElementById(`participantes-sesion-${idSesion}`);
                if (!contenedor) return;
                
                const participantes = datos.participantes || [];
                
                if (participantes.length === 0) {
                    contenedor.innerHTML = '';
                    return;
                }

                contenedor.innerHTML = `
                    <div class="contenedor-participantes-tiempo-real">
                        <h4>üë• Participantes conectados (${participantes.length}):</h4>
                        <div class="lista-participantes-tiempo-real">
                            ${participantes.map(p => `
                                <div class="participante-chip">
                                    ${p.nombre_usuario}${p.nombre_grupo ? ` - ${p.nombre_grupo}` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando participantes:', error);
            }
        }

        // ============================================================
        // ‚úÖ ACTUALIZAR VISUALIZACI√ìN DEL TEMPORIZADOR
        // ============================================================
        function actualizarVisualizacionTemporizador(idSesion) {
            const elemento = document.getElementById(`temporizador-${idSesion}`);
            if (!elemento) return;
            
            const expira = window.temporizadoresSesion[idSesion];
            if (!expira) {
                elemento.textContent = '‚è≥ Queda: --:--';
                return;
            }
            
            const ahora = Date.now();
            const restante = Math.max(0, expira - ahora);
            
            // ‚úÖ VALIDAR QUE EL TIEMPO RESTANTE SEA RAZONABLE
            if (restante > 86400000) {
                console.error('Tiempo restante inv√°lido:', restante, 'para sesi√≥n', idSesion);
                elemento.textContent = '‚è≥ Queda: --:--';
                return;
            }
            
            const minutos = Math.floor(restante / 60000);
            const segundos = Math.floor((restante % 60000) / 1000);
            
            elemento.textContent = `‚è≥ Queda: ${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
            
            if (restante === 0) {
                console.log('‚è∞ Tiempo agotado para sesi√≥n', idSesion);
                finalizarSesionQuiz(idSesion, true);
                delete window.temporizadoresSesion[idSesion];
                guardarTemporizadores();
            }
        }

        // ‚úÖ ACTUALIZAR TEMPORIZADORES CADA SEGUNDO
        setInterval(() => {
            Object.keys(window.temporizadoresSesion).forEach(idSesion => {
                actualizarVisualizacionTemporizador(idSesion);
            });
        }, 1000);

        // ============================================================
        // ‚úÖ INICIAR SESI√ìN DE QUIZ
        // ============================================================
        async function iniciarSesionQuiz(idSesion) {
            const inputIntentos = document.getElementById(`intentos-${idSesion}`);
            const intentos = parseInt(inputIntentos?.value || 0);
            
            const tiempoMinutos = prompt('¬øCu√°ntos minutos durar√° el quiz?\n(Dejar vac√≠o para usar el tiempo de cada pregunta)', '');
            
            let duracionMinutos = null;
            if (tiempoMinutos !== null && tiempoMinutos.trim() !== '') {
                duracionMinutos = parseInt(tiempoMinutos);
                if (isNaN(duracionMinutos) || duracionMinutos <= 0) {
                    alert('‚ö†Ô∏è Por favor ingresa un n√∫mero v√°lido de minutos');
                    return;
                }
            }
            
            const mensajeConfirmacion = duracionMinutos 
                ? `¬øIniciar el quiz con ${intentos} intentos y ${duracionMinutos} minutos?`
                : `¬øIniciar el quiz con ${intentos} intentos (tiempo: suma de cada pregunta)?`;
            
            if (!confirm(mensajeConfirmacion)) {
                return;
            }
            
            try {
                const payload = { intentos: intentos };
                if (duracionMinutos !== null) {
                    payload.duracion_minutos = duracionMinutos;
                }
                
                console.log('üì§ Enviando:', payload);
                
                const respuesta = await fetch(`/api/sesion/${idSesion}/iniciar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (respuesta.ok) {
                    const datos = await respuesta.json();
                    console.log('‚úÖ Respuesta servidor:', datos);
                    
                    alert('‚úÖ Quiz iniciado');
                    
                    // ‚úÖ CALCULAR TIEMPO DE EXPIRACI√ìN
                    if (datos.expira_en_seg && datos.expira_en_seg > 0) {
                        const ahora = Date.now();
                        const expirationTimestamp = ahora + (datos.expira_en_seg * 1000);
                        window.temporizadoresSesion[idSesion] = expirationTimestamp;
                        guardarTemporizadores();
                        
                        console.log('‚è∞ Temporizador configurado:', {
                            ahora: new Date(ahora).toLocaleString(),
                            expira: new Date(expirationTimestamp).toLocaleString(),
                            segundos_restantes: datos.expira_en_seg
                        });
                    }
                    
                    if (quizActualProyectado) {
                        document.getElementById('contenedorSesionesActivas').innerHTML = '';
                        await cargarSesionesActivasEnModal(quizActualProyectado);
                    }
                } else {
                    const error = await respuesta.json();
                    alert('‚ùå Error: ' + (error.error || 'No se pudo iniciar el quiz'));
                }
            } catch (error) {
                console.error('Error iniciando quiz:', error);
                alert('Error de conexi√≥n');
            }
        }

        // ============================================================
        // FINALIZAR SESI√ìN DE QUIZ
        // ============================================================
        async function finalizarSesionQuiz(idSesion, automatico = false) {
            if (!automatico && !confirm('¬øFinalizar el quiz ahora? Los participantes no podr√°n continuar.')) return;
            
            try {
                const respuesta = await fetch(`/api/sesion/${idSesion}/finalizar`, { method: 'POST' });
                if (respuesta.ok) {
                    if (!automatico) alert('‚úÖ Quiz finalizado');
                    delete window.temporizadoresSesion[idSesion];
                    guardarTemporizadores();
                    
                    if (quizActualProyectado) {
                        cargarSesionesActivasEnModal(quizActualProyectado);
                    }
                } else {
                    alert('‚ùå Error finalizando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        // ============================================================
        // GESTI√ìN DE PREGUNTAS
        // ============================================================
        let idQuizSeleccionado = null;
        let quizData = {};

        function capturarValoresActuales() {
            const valores = {};
            document.querySelectorAll('#listaPreguntas input, #listaPreguntas textarea').forEach(input => {
                if (input.id) {
                    if (input.type === 'checkbox') {
                        valores[input.id] = input.checked;
                    } else {
                        valores[input.id] = input.value;
                    }
                }
            });
            return valores;
        }

        function restaurarValoresCapturados(valores) {
            Object.keys(valores).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = valores[id];
                    } else {
                        input.value = valores[id];
                    }
                }
            });
        }

        async function gestionarPreguntas(idQuiz) {
            try {
                idQuizSeleccionado = idQuiz;
                document.getElementById('listaPreguntas').innerHTML = '<p style="color:#666;">Cargando preguntas...</p>';
                document.getElementById('modalPreguntasQuiz').classList.add('activo');

                const resp = await fetch(`/api/quizzes/${idQuizSeleccionado}`);
                if (!resp.ok) throw new Error('No se pudo cargar el quiz');
                quizData = await resp.json();

                mostrarPreguntas(quizData.preguntas || []);
            } catch (e) {
                alert('‚ùå Error al cargar preguntas');
                console.error(e);
            }
        }

        function mostrarPreguntas(preguntas) {
            const cont = document.getElementById('listaPreguntas');
            if (!preguntas || preguntas.length === 0) {
                cont.innerHTML = `
                <div class="estado-vacio">
                <div class="icono-estado-vacio">üìù</div>
                <h3>No hay preguntas a√∫n</h3>
                <p>Agrega tu primera pregunta</p>
                </div>`;
                return;
            }
            cont.innerHTML = preguntas.map((pregunta) => {
                const opcionesHTML = (pregunta.opciones || []).map((opcion) => `
                <div class="opcion">
                <input id="opt-check-${pregunta.id}-${opcion.id}" type="checkbox"
                    ${opcion.es_correcta ? 'checked' : ''}>
                <input id="opt-text-${pregunta.id}-${opcion.id}" type="text"
                    value="${opcion.texto_opcion || ''}">
                <button class="boton-eliminar" type="button"
                    onclick="eliminarOpcion(${pregunta.id}, ${opcion.id})">üóëÔ∏è</button>
                </div>
            `).join('');

                return `
                <div class="tarjeta-quiz" style="border-left:4px solid #667eea; margin-bottom: 15px;">
                <div class="grupo-formulario">
                    <label>Texto de la pregunta</label>
                    <input id="preg-text-${pregunta.id}" type="text"
                        value="${pregunta.texto_pregunta}">
                </div>
                <div class="grupo-formulario">
                    <label>Tiempo l√≠mite (segundos)</label>
                    <input id="preg-tiempo-${pregunta.id}" type="number"
                        value="${pregunta.tiempo_limite || 30}">
                </div>
                <div class="grupo-formulario">
                    <label>URL de imagen (opcional)</label>
                    <input id="preg-img-${pregunta.id}" type="text"
                        value="${pregunta.url_imagen || ''}">
                </div>
                <div class="grupo-formulario">
                    <label>URL de video (opcional)</label>
                    <input id="preg-video-${pregunta.id}" type="text"
                        value="${pregunta.url_video || ''}">
                </div>
                <div class="grupo-formulario">
                    <label>Opciones</label>
                    ${opcionesHTML}
                    <div class="opcion-acciones">
                    <button class="boton" type="button" onclick="agregarOpcion(${pregunta.id})">‚ûï Agregar opci√≥n</button>
                    <button class="boton-eliminar" type="button" onclick="eliminarPregunta(${pregunta.id})">‚ùå Eliminar pregunta</button>
                    </div>
                </div>
                </div>
            `;
            }).join('');
        }

        async function recargarPreguntas() {
            const valoresGuardados = capturarValoresActuales();
            const resp = await fetch(`/api/quizzes/${idQuizSeleccionado}`);
            const data = await resp.json();
            quizData = data;
            mostrarPreguntas(quizData.preguntas || []);
            setTimeout(() => restaurarValoresCapturados(valoresGuardados), 50);
        }

        async function agregarPregunta() {
            if (!idQuizSeleccionado) {
                alert('‚ö†Ô∏è No hay quiz seleccionado');
                return;
            }

            const valoresGuardados = capturarValoresActuales();

            const nueva = {
                texto_pregunta: "Nueva pregunta",
                tiempo_limite: 30,
                posicion: (quizData.preguntas?.length || 0) + 1,
                opciones: [
                    { texto_opcion: "Opci√≥n A", es_correcta: false },
                    { texto_opcion: "Opci√≥n B", es_correcta: true }
                ]
            };

            const resp = await fetch(`/api/quizzes/${idQuizSeleccionado}/preguntas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nueva)
            });

            if (resp.ok) {
                await recargarPreguntas();
                setTimeout(() => restaurarValoresCapturados(valoresGuardados), 100);
            } else {
                alert('‚ùå Error al agregar la pregunta');
            }
        }

        async function agregarOpcion(idPregunta) {
            const valoresGuardados = capturarValoresActuales();
            const pregunta = quizData.preguntas.find(p => p.id === idPregunta);
            if (!pregunta) return;

            const opcionesActualizadas = (pregunta.opciones || []).map(o => {
                const inputTexto = document.getElementById(`opt-text-${idPregunta}-${o.id}`);
                const inputCheck = document.getElementById(`opt-check-${idPregunta}-${o.id}`);
                return {
                    id: o.id,
                    texto_opcion: inputTexto ? inputTexto.value : o.texto_opcion,
                    es_correcta: inputCheck ? inputCheck.checked : o.es_correcta
                };
            });

            const nuevasOpciones = opcionesActualizadas.concat([{
                texto_opcion: "Nueva opci√≥n",
                es_correcta: false
            }]);

            await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ opciones: nuevasOpciones })
            });

            await recargarPreguntas();
            setTimeout(() => restaurarValoresCapturados(valoresGuardados), 100);
        }

        async function eliminarOpcion(idPregunta, idOpcion) {
            const valoresGuardados = capturarValoresActuales();
            const pregunta = quizData.preguntas.find(p => p.id === idPregunta);
            if (!pregunta) return;

            const opcionesActualizadas = (pregunta.opciones || [])
                .filter(o => o.id !== idOpcion)
                .map(o => {
                    const inputTexto = document.getElementById(`opt-text-${idPregunta}-${o.id}`);
                    const inputCheck = document.getElementById(`opt-check-${idPregunta}-${o.id}`);
                    return {
                        id: o.id,
                        texto_opcion: inputTexto ? inputTexto.value : o.texto_opcion,
                        es_correcta: inputCheck ? inputCheck.checked : o.es_correcta
                    };
                });

            await fetch(`/api/preguntas/${idPregunta}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ opciones: opcionesActualizadas })
            });

            await recargarPreguntas();
            setTimeout(() => restaurarValoresCapturados(valoresGuardados), 100);
        }

        async function eliminarPregunta(idPregunta) {
            if (!confirm('¬øSeguro que deseas eliminar esta pregunta?')) return;
            const valoresGuardados = capturarValoresActuales();
            const resp = await fetch(`/api/preguntas/${idPregunta}`, { method: 'DELETE' });

            if (resp.ok) {
                await recargarPreguntas();
                setTimeout(() => restaurarValoresCapturados(valoresGuardados), 100);
            } else {
                alert('‚ùå No se pudo eliminar la pregunta');
            }
        }

        async function guardarPreguntas() {
            if (!quizData || !quizData.preguntas || quizData.preguntas.length === 0) {
                alert('No hay preguntas para guardar');
                return;
            }

            try {
                for (const p of quizData.preguntas) {
                    const texto_pregunta = document.getElementById(`preg-text-${p.id}`)?.value ?? p.texto_pregunta ?? '';
                    const tiempo_limite = parseInt(document.getElementById(`preg-tiempo-${p.id}`)?.value ?? p.tiempo_limite ?? 30, 10) || 30;
                    const url_imagen = document.getElementById(`preg-img-${p.id}`)?.value ?? p.url_imagen ?? null;
                    const url_video = document.getElementById(`preg-video-${p.id}`)?.value ?? p.url_video ?? null;

                    const opciones_leidas = (p.opciones || []).map(o => {
                        const texto = document.getElementById(`opt-text-${p.id}-${o.id}`)?.value ?? o.texto_opcion ?? '';
                        const check = !!document.getElementById(`opt-check-${p.id}-${o.id}`)?.checked;
                        return { texto_opcion: texto, es_correcta: check };
                    });

                    const resp = await fetch(`/api/preguntas/${p.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            texto_pregunta,
                            url_imagen,
                            url_video,
                            tiempo_limite,
                            posicion: p.posicion || 0,
                            opciones: opciones_leidas
                        })
                    });

                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        console.error('Error guardando pregunta', p.id, err);
                        alert('‚ùå Error al guardar alguna pregunta. Revisa consola.');
                        return;
                    }
                }

                alert('‚úÖ Preguntas guardadas correctamente');
                cerrarModal('modalPreguntasQuiz');
                await cargarQuizzes();

            } catch (e) {
                console.error(e);
                alert('‚ùå Error de conexi√≥n guardando preguntas');
            }
        }

        // ============================================================
        // DUPLICAR QUIZ
        // ============================================================
        async function duplicarQuiz(idQuiz) {
            if (!confirm('¬øDeseas duplicar este quiz y sus preguntas?')) return;
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
                const quiz = await respuesta.json();
                if (!quiz || !quiz.id) {
                    alert('No se pudo cargar el quiz original');
                    return;
                }

                const nuevoQuiz = {
                    titulo: quiz.titulo + ' (Copia)',
                    descripcion: quiz.descripcion,
                    modo: quiz.modo,
                    num_grupos: quiz.num_grupos || 0,
                    es_publico: false
                };

                const respuestaCrear = await fetch('/api/quizzes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoQuiz)
                });

                const creado = await respuestaCrear.json();
                if (!respuestaCrear.ok || !creado.id_quiz) {
                    alert('No se pudo crear la copia');
                    return;
                }

                const nuevoIdQuiz = creado.id_quiz;

                const preguntas = quiz.preguntas || [];
                for (const p of preguntas) {
                    const cargaUtil = {
                        texto_pregunta: p.texto_pregunta,
                        url_imagen: p.url_imagen,
                        url_video: p.url_video,
                        tiempo_limite: p.tiempo_limite,
                        posicion: p.posicion || 0,
                        opciones: (p.opciones || []).map(o => ({
                            texto_opcion: o.texto_opcion,
                            es_correcta: !!o.es_correcta
                        }))
                    };
                    await fetch(`/api/quizzes/${nuevoIdQuiz}/preguntas`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cargaUtil)
                    });
                }

                alert('‚úÖ Quiz duplicado exitosamente con sus preguntas');
                if (confirm('¬øDeseas abrir el editor de preguntas de la copia?')) {
                    gestionarPreguntas(nuevoIdQuiz);
                } else {
                    cargarQuizzes();
                }
            } catch (error) {
                console.error(error);
                alert('Error duplicando el quiz');
            }
        }

        // ============================================================
        // ELIMINAR QUIZ
        // ============================================================
        function confirmarEliminarQuiz(idQuiz) {
            document.getElementById('tituloConfirmacion').textContent = '¬øEliminar Quiz?';
            document.getElementById('mensajeConfirmacion').textContent = 'Esta acci√≥n eliminar√° el quiz y todas sus preguntas. No se puede deshacer.';
            callbackConfirmacion = () => eliminarQuiz(idQuiz);
            document.getElementById('modalConfirmacion').classList.add('activo');
        }

        async function eliminarQuiz(idQuiz) {
            try {
                const respuesta = await fetch(`/api/quizzes/${idQuiz}`, { method: 'DELETE' });
                if (respuesta.ok) {
                    alert('‚úÖ Quiz eliminado');
                    cerrarModal('modalConfirmacion');
                    cargarQuizzes();
                } else {
                    alert('‚ùå Error eliminando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        function confirmarAccion() {
            if (callbackConfirmacion) {
                callbackConfirmacion();
                callbackConfirmacion = null;
            }
        }

        // ============================================================
        // CERRAR MODAL
        // ============================================================
        function cerrarModal(idModal) {
            document.getElementById(idModal).classList.remove('activo');
            
            if (idModal === 'modalProyectarQuiz') {
                if (intervaloSesionesActivas) {
                    clearInterval(intervaloSesionesActivas);
                    intervaloSesionesActivas = null;
                }
                quizActualProyectado = null;
            }
        }

        // ============================================================
        // FORMULARIO CREAR/EDITAR QUIZ
        // ============================================================
        document.getElementById('formularioQuiz').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!confirm('¬øDeseas guardar este quiz?')) {
                return;
            }

            const idQuiz = document.getElementById('idQuiz').value;
            const modo = document.getElementById('modo').value;
            const datosQuiz = {
                titulo: document.getElementById('titulo').value,
                descripcion: document.getElementById('descripcion').value,
                modo: modo,
                num_grupos: modo === 'grupal' ? parseInt(document.getElementById('numGrupos').value) : 0,
                es_publico: document.getElementById('esPublico').checked
            };

            try {
                const url = idQuiz ? `/api/quizzes/${idQuiz}` : '/api/quizzes';
                const metodo = idQuiz ? 'PUT' : 'POST';
                const respuesta = await fetch(url, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosQuiz)
                });

                const datos = await respuesta.json();
                if (respuesta.ok) {
                    alert('‚úÖ Quiz guardado exitosamente');
                    cerrarModal('modalQuiz');
                    cargarQuizzes();
                    if (!idQuiz && datos.id_quiz) {
                        if (confirm('¬øDeseas agregar preguntas ahora?')) {
                            gestionarPreguntas(datos.id_quiz);
                        }
                    }
                } else {
                    alert('‚ùå Error guardando el quiz');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        });

        // ============================================================
        // IMPORTAR PREGUNTAS
        // ============================================================
        function abrirImportarPreguntas() {
            if (!idQuizSeleccionado) {
                alert('‚ö†Ô∏è No hay quiz seleccionado');
                return;
            }

            const inputArchivo = document.getElementById('archivoExcelPreguntas');
            if (inputArchivo) {
                inputArchivo.value = '';
            }

            const divResultado = document.getElementById('resultadoImportacion');
            if (divResultado) {
                divResultado.style.display = 'none';
            }

            document.getElementById('modalImportarPreguntas').classList.add('activo');
        }

        async function descargarPlantilla() {
            try {
                const respuesta = await fetch('/api/plantilla_excel');

                if (!respuesta.ok) {
                    throw new Error('Error al descargar la plantilla');
                }

                const blob = await respuesta.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'plantilla_preguntas.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert('‚úÖ Plantilla descargada exitosamente');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al descargar la plantilla');
            }
        }

        async function procesarImportacion() {
            const inputArchivo = document.getElementById('archivoExcelPreguntas');
            const divResultado = document.getElementById('resultadoImportacion');
            const divMensaje = document.getElementById('mensajeImportacion');

            if (!inputArchivo.files || inputArchivo.files.length === 0) {
                alert('‚ö†Ô∏è Por favor selecciona un archivo Excel');
                return;
            }

            const archivo = inputArchivo.files[0];

            if (!archivo.name.endsWith('.xlsx') && !archivo.name.endsWith('.xls')) {
                alert('‚ö†Ô∏è Solo se permiten archivos Excel (.xlsx o .xls)');
                return;
            }

            const formData = new FormData();
            formData.append('archivo', archivo);

            try {
                divMensaje.innerHTML = '<p style="text-align: center;">‚è≥ Procesando archivo, por favor espera...</p>';
                divMensaje.style.background = '#fff3cd';
                divMensaje.style.color = '#856404';
                divResultado.style.display = 'block';

                const respuesta = await fetch(`/api/quizzes/${idQuizSeleccionado}/importar_preguntas`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const datos = await respuesta.json();

                if (respuesta.ok) {
                    let mensajeHTML = `<h3 style="color: #155724;">‚úÖ ${datos.mensaje}</h3>`;

                    if (datos.errores && datos.errores.length > 0) {
                        mensajeHTML += '<hr style="margin: 15px 0;">';
                        mensajeHTML += '<h4 style="color: #856404;">‚ö†Ô∏è Errores encontrados:</h4>';
                        mensajeHTML += '<ul style="margin-left: 20px; line-height: 1.8;">';
                        datos.errores.forEach(error => {
                            mensajeHTML += `<li style="color: #856404;">${error}</li>`;
                        });
                        mensajeHTML += '</ul>';
                    }

                    divMensaje.innerHTML = mensajeHTML;
                    divMensaje.style.background = '#d4edda';
                    divMensaje.style.color = '#155724';
                    divMensaje.style.border = '1px solid #c3e6cb';

                    setTimeout(async () => {
                        await recargarPreguntas();
                        cerrarModal('modalImportarPreguntas');
                        alert(`‚úÖ Importaci√≥n completada: ${datos.preguntas_importadas} pregunta(s) agregada(s)`);
                    }, 2000);

                } else {
                    divMensaje.innerHTML = `<h3 style="color: #721c24;">‚ùå Error</h3><p>${datos.error}</p>`;
                    divMensaje.style.background = '#f8d7da';
                    divMensaje.style.color = '#721c24';
                    divMensaje.style.border = '1px solid #f5c6cb';
                }

            } catch (error) {
                console.error('Error:', error);
                divMensaje.innerHTML = `<h3 style="color: #721c24;">‚ùå Error de conexi√≥n</h3><p>${error.message}</p>`;
                divMensaje.style.background = '#f8d7da';
                divMensaje.style.color = '#721c24';
                divMensaje.style.border = '1px solid #f5c6cb';
                divResultado.style.display = 'block';
            }
        }

        // ============================================================
        // INICIALIZACI√ìN
        // ============================================================
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üöÄ Inicializando Panel de Profesor...');

            const autenticado = await cargarInfoUsuario();

            if (!autenticado) {
                console.error('‚ùå Usuario no autenticado o no es profesor');
                return;
            }

            console.log('‚úÖ Cargando quizzes...');
            cargarQuizzes();
        });
    </script>
</body>

</html>