<!-- templates/ver_sala_juego.html SINCRONIZADO -->
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modo Anfitri√≥n - QuizPlatform</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .barra-navegacion {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .barra-navegacion h1 {
      font-size: 1.8em;
    }

    .derecha-navegacion {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .boton {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: 2px solid white;
      padding: 10px 20px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: bold;
      transition: all .2s ease;
    }

    .boton:hover {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .contenido-pagina {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      min-height: 100vh;
    }

    .contenedor-juego {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
      text-align: center;
    }

    .contenedor-pregunta {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
    }

    /* ‚úÖ NUEVO: Display de tiempo num√©rico */
    .display-tiempo {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .display-tiempo .tiempo-numero {
      font-size: 3em;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      letter-spacing: 3px;
    }

    .display-tiempo .tiempo-label {
      font-size: 0.9em;
      opacity: 0.9;
      margin-top: 5px;
    }

    .display-tiempo.critico {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .numero-pregunta {
      color: #667eea;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .texto-pregunta {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .multimedia-pregunta img {
      max-width: 100%;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .cuadricula-respuestas {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .boton-respuesta {
      padding: 20px;
      border: 3px solid #e0e0e0;
      border-radius: 15px;
      background: white;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 1em;
      font-weight: 500;
      transition: all .3s ease;
      cursor: default;
      user-select: none;
    }

    .letra-respuesta {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      flex-shrink: 0;
    }

    .texto-respuesta {
      flex: 1;
      text-align: left;
    }

    .boton-respuesta.correcta {
      border-color: #4caf50;
      background: #4caf50;
      color: white;
    }

    .pantalla-resultados {
      display: none;
      text-align: center;
    }

    .pantalla-resultados.activa {
      display: block;
    }

    .encabezado-resultados {
      margin-bottom: 30px;
    }

    .mostrar-puntuacion {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .lista-clasificacion {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .elemento-clasificacion {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .posicion-clasificacion {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .posicion-clasificacion.primero {
      background: #ffd700;
      color: #333;
    }

    .posicion-clasificacion.segundo {
      background: #c0c0c0;
      color: #333;
    }

    .posicion-clasificacion.tercero {
      background: #cd7f32;
      color: white;
    }

    @media (max-width:768px) {
      .cuadricula-respuestas {
        grid-template-columns: 1fr;
      }
      
      .display-tiempo .tiempo-numero {
        font-size: 2.5em;
      }
    }
  </style>
</head>

<body data-id-sesion="{{ id_sesion }}">
  <div class="barra-navegacion">
    <h1>üéØ QuizPlatform</h1>
    <div class="derecha-navegacion">
      <span>Bienvenido, <strong id="nombreUsuarioAnfitrion"></strong></span>
      <a href="/panel_control" class="boton">‚Üê Volver al Panel</a>
      <a href="/cerrar_sesion" class="boton">Cerrar Sesi√≥n</a>
    </div>
  </div>

  <div class="contenido-pagina">
    <div class="contenedor-juego">
      <div id="pantallaJuego" class="pantalla-juego activa">
        <div class="contenedor-pregunta">
          <!-- ‚úÖ NUEVO: Display de tiempo num√©rico -->
          <div class="display-tiempo" id="displayTiempo">
            <div class="tiempo-numero" id="tiempoNumero">00:00</div>
            <div class="tiempo-label">Tiempo restante</div>
          </div>
          
          <div class="numero-pregunta" id="numeroPregunta">Pregunta 1 de 1</div>
          <div class="texto-pregunta" id="textoPregunta"></div>
          <div class="multimedia-pregunta" id="multimediaPregunta"></div>
        </div>
        <div class="cuadricula-respuestas" id="cuadriculaRespuestas"></div>
      </div>

      <div id="pantallaResultados" class="pantalla-resultados">
        <div class="encabezado-resultados">
          <h2>üéâ ¬°Juego Terminado!</h2>
        </div>
        <div class="mostrar-puntuacion">
          <h3 id="puntuacionFinal">‚Äî</h3>
          <p>Vista del Profesor</p>
        </div>
        <div class="lista-clasificacion">
          <h3 style="margin-bottom:15px; color:#333;">üèÜ Clasificaci√≥n Final</h3>
          <div id="listaClasificacion"></div>
        </div>
        <button class="boton" id="btnExportar" onclick="exportarResultados()">üìä Exportar Resultados</button>
        <a href="/panel_control" class="boton" style="display:inline-block; margin-top:10px;">Volver al Panel</a>
      </div>
    </div>
  </div>

  <script>
    const idSesion = document.body.dataset.idSesion;
    let preguntas = [];
    let preguntaActual = 0;
    let intervaloTemporizador = null;
    let intervaloConsulta = null;
    let expiraTemporizador = null; // ‚úÖ TIMESTAMP de expiraci√≥n del quiz completo
    let tiemposAcumuladosPreguntas = []; // ‚úÖ Array con tiempo acumulado hasta cada pregunta

    fetch('/api/info_sesion').then(r => r.json()).then(d => {
      if (d.nombre_usuario) document.getElementById('nombreUsuarioAnfitrion').textContent = d.nombre_usuario;
    }).catch(() => {});

    // ‚úÖ CARGA SIMPLIFICADA: Usa expira_temporizador directamente
    async function cargarSesionYPreguntas() {
      try {
        const respuesta = await fetch(`/api/sesion/${idSesion}/info`);
        if (!respuesta.ok) throw new Error('Sesi√≥n no encontrada');
        const infoSesion = await respuesta.json();

        if (!infoSesion.quiz || !infoSesion.quiz.id) {
          throw new Error('Quiz no disponible');
        }

        // ‚úÖ GUARDAR expira_temporizador
        if (infoSesion.expira_temporizador) {
          try {
            const expiraStr = infoSesion.expira_temporizador.replace(' ', 'T');
            const expiraDate = new Date(expiraStr);
            if (!isNaN(expiraDate.getTime())) {
              expiraTemporizador = expiraDate.getTime();
              console.log('‚úÖ Expiraci√≥n configurada:', new Date(expiraTemporizador).toLocaleString());
            }
          } catch (e) {
            console.error('‚ùå Error procesando expira_temporizador:', e);
          }
        }

        await cargarPreguntas(infoSesion.quiz.id);

        const respuestaEstado = await fetch(`/api/sesion/${idSesion}/verificar_estado`);
        const datosEstado = await respuestaEstado.json();

        if (datosEstado && datosEstado.activa && datosEstado.estado === 'iniciada') {
          if (expiraTemporizador) {
            iniciarDesdeExpiracion();
          } else {
            mostrarPregunta(0, true);
          }
        } else {
          if (preguntas.length > 0) {
            mostrarPregunta(0, false);
          }
          consultarEstado();
        }
      } catch (error) {
        console.error('Error cargando sesi√≥n:', error);
        document.getElementById('textoPregunta').textContent = '‚ö†Ô∏è Error cargando sesi√≥n.';
      }
    }

    async function cargarPreguntas(idQuiz) {
      try {
        const respuesta = await fetch(`/api/quizzes/${idQuiz}`);
        if (!respuesta.ok) {
          preguntas = [];
          return;
        }
        const quiz = await respuesta.json();
        preguntas = quiz.preguntas || [];
        
        // ‚úÖ Calcular tiempos acumulados
        calcularTiemposAcumulados();
      } catch (e) {
        console.error('Error cargarPreguntas:', e);
        preguntas = [];
      }
    }

    // ‚úÖ NUEVA FUNCI√ìN: Calcular tiempos acumulados
    function calcularTiemposAcumulados() {
      tiemposAcumuladosPreguntas = [];
      let acumulado = 0;
      preguntas.forEach(pregunta => {
        tiemposAcumuladosPreguntas.push(acumulado);
        acumulado += parseInt(pregunta.tiempo_limite) || 30;
      });
    }

    // ‚úÖ NUEVA FUNCI√ìN: Calcular tiempo restante sincronizado
    function calcularTiempoRestante(indicePregunta) {
      if (!expiraTemporizador || !tiemposAcumuladosPreguntas.length) {
        // Fallback: usar tiempo_limite de la pregunta
        const pregunta = preguntas[indicePregunta];
        return parseInt(pregunta?.tiempo_limite) || 30;
      }

      const ahora = Date.now();
      const tiempoRestanteTotal = Math.max(0, Math.floor((expiraTemporizador - ahora) / 1000));
      
      // Calcular tiempo transcurrido desde el inicio del quiz
      const tiempoTotalQuiz = tiemposAcumuladosPreguntas[tiemposAcumuladosPreguntas.length - 1] + 
                               (parseInt(preguntas[preguntas.length - 1]?.tiempo_limite) || 30);
      const tiempoTranscurrido = tiempoTotalQuiz - tiempoRestanteTotal;
      
      // Calcular tiempo restante para esta pregunta espec√≠fica
      const tiempoInicioPregunta = tiemposAcumuladosPreguntas[indicePregunta];
      const tiempoLimitePregunta = parseInt(preguntas[indicePregunta]?.tiempo_limite) || 30;
      const tiempoTranscurridoEnPregunta = Math.max(0, tiempoTranscurrido - tiempoInicioPregunta);
      
      return Math.max(0, tiempoLimitePregunta - tiempoTranscurridoEnPregunta);
    }

    // ‚úÖ CALCULAR PREGUNTA ACTUAL DESDE expira_temporizador
    function iniciarDesdeExpiracion() {
      if (!expiraTemporizador || !preguntas || preguntas.length === 0) {
        mostrarPregunta(0, true);
        return;
      }

      const ahora = Date.now();
      const tiempoRestanteTotal = Math.max(0, expiraTemporizador - ahora);
      
      // Si ya expir√≥, mostrar resultados
      if (tiempoRestanteTotal === 0) {
        mostrarResultados();
        return;
      }

      // Calcular tiempo total del quiz
      const tiempoTotalQuiz = preguntas.reduce((sum, p) => sum + (parseInt(p.tiempo_limite) || 30), 0);
      const tiempoTranscurrido = tiempoTotalQuiz - Math.floor(tiempoRestanteTotal / 1000);

      // Encontrar pregunta actual
      let tiempoAcumulado = 0;
      let indice = 0;
      for (let i = 0; i < preguntas.length; i++) {
        const tiempoPregunta = parseInt(preguntas[i].tiempo_limite) || 30;
        if (tiempoAcumulado + tiempoPregunta > tiempoTranscurrido) {
          indice = i;
          break;
        }
        tiempoAcumulado += tiempoPregunta;
        indice = i + 1;
      }

      if (indice >= preguntas.length) {
        mostrarResultados();
        return;
      }

      mostrarPregunta(indice, true);
    }

    function mostrarPregunta(indice, iniciarAuto = true) {
      if (!preguntas || preguntas.length === 0) {
        document.getElementById('numeroPregunta').textContent = 'Sin preguntas';
        document.getElementById('textoPregunta').textContent = 'Este quiz no tiene preguntas.';
        return;
      }

      if (indice >= preguntas.length) {
        mostrarResultados();
        return;
      }

      const p = preguntas[indice];
      preguntaActual = indice;

      document.getElementById('numeroPregunta').textContent = `Pregunta ${indice + 1} de ${preguntas.length}`;
      document.getElementById('textoPregunta').textContent = p.texto_pregunta || '';
      document.getElementById('multimediaPregunta').innerHTML = p.url_imagen ? `<img src="${p.url_imagen}" alt="Imagen">` : '';

      const cuadricula = document.getElementById('cuadriculaRespuestas');
      cuadricula.innerHTML = (p.opciones || []).map((opcion, i) => `
        <div class="boton-respuesta ${opcion.es_correcta ? 'correcta' : ''}">
          <div class="letra-respuesta">${String.fromCharCode(65 + i)}</div>
          <div class="texto-respuesta">${opcion.texto_opcion}</div>
        </div>
      `).join('');

      if (iniciarAuto) {
        iniciarTemporizadorSincronizado(indice);
      } else {
        actualizarDisplayTiempo(parseInt(p.tiempo_limite) || 30);
      }
    }

    // ‚úÖ NUEVA FUNCI√ìN: Temporizador sincronizado
    function iniciarTemporizadorSincronizado(indicePregunta) {
      if (intervaloTemporizador) {
        clearInterval(intervaloTemporizador);
        intervaloTemporizador = null;
      }

      // Calcular tiempo restante inicial
      let tiempoRestante = calcularTiempoRestante(indicePregunta);
      
      // Actualizar display inmediatamente
      actualizarDisplayTiempo(tiempoRestante);
      
      // Actualizar cada segundo
      intervaloTemporizador = setInterval(() => {
        tiempoRestante = calcularTiempoRestante(indicePregunta);
        actualizarDisplayTiempo(tiempoRestante);
        
        // Si el tiempo se agot√≥, avanzar a la siguiente pregunta
        if (tiempoRestante <= 0) {
          clearInterval(intervaloTemporizador);
          intervaloTemporizador = null;
          setTimeout(() => mostrarPregunta(preguntaActual + 1, true), 800);
        }
      }, 1000);
    }

    // ‚úÖ NUEVA FUNCI√ìN: Actualizar display de tiempo
    function actualizarDisplayTiempo(segundos) {
      const minutos = Math.floor(segundos / 60);
      const segs = segundos % 60;
      const displayTiempo = document.getElementById('displayTiempo');
      const tiempoNumero = document.getElementById('tiempoNumero');
      
      tiempoNumero.textContent = `${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
      
      // Cambiar color cuando quedan menos de 10 segundos
      if (segundos <= 10) {
        displayTiempo.classList.add('critico');
      } else {
        displayTiempo.classList.remove('critico');
      }
    }

    async function consultarEstado() {
      try {
        const respuesta = await fetch(`/api/sesion/${idSesion}/verificar_estado`);
        if (!respuesta.ok) return;
        const s = await respuesta.json();

        if (!s.activa || s.estado === 'finalizada') {
          if (intervaloTemporizador) clearInterval(intervaloTemporizador);
          await mostrarResultados();
          return;
        }

        if (s.estado === 'iniciada' && !expiraTemporizador) {
          const respuestaInfo = await fetch(`/api/sesion/${idSesion}/info`);
          if (respuestaInfo.ok) {
            const datosInfo = await respuestaInfo.json();
            if (datosInfo.expira_temporizador) {
              const expiraStr = datosInfo.expira_temporizador.replace(' ', 'T');
              const expiraDate = new Date(expiraStr);
              if (!isNaN(expiraDate.getTime())) {
                expiraTemporizador = expiraDate.getTime();
                await cargarPreguntas(datosInfo.quiz.id);
                iniciarDesdeExpiracion();
              }
            }
          }
        }
      } catch (error) {
        console.error('Error consultarEstado:', error);
      } finally {
        if (!intervaloConsulta) {
          intervaloConsulta = setTimeout(consultarEstado, 2000);
        }
      }
    }

    async function mostrarResultados() {
      if (intervaloConsulta) {
        clearTimeout(intervaloConsulta);
        intervaloConsulta = null;
      }
      if (intervaloTemporizador) {
        clearInterval(intervaloTemporizador);
        intervaloTemporizador = null;
      }

      document.getElementById('pantallaJuego').style.display = 'none';
      document.getElementById('pantallaResultados').classList.add('activa');

      try {
        const respuesta = await fetch(`/api/resultados_juego/${idSesion}`);
        if (!respuesta.ok) throw new Error('Error al obtener resultados');
        const clasificacion = await respuesta.json();

        const elementoLista = document.getElementById('listaClasificacion');
        elementoLista.innerHTML = clasificacion.map((participante, indice) => {
          const clase = indice === 0 ? 'primero' : indice === 1 ? 'segundo' : indice === 2 ? 'tercero' : '';
          const medalla = indice === 0 ? 'ü•á' : indice === 1 ? 'ü•à' : indice === 2 ? 'ü•â' : (indice + 1);
          return `
            <div class="elemento-clasificacion">
              <div class="posicion-clasificacion ${clase}">${medalla}</div>
              <div class="nombre-clasificacion">${participante.nombre_usuario}</div>
              <div class="puntuacion-clasificacion">${participante.puntuacion_total} pts</div>
            </div>`;
        }).join('');
      } catch (error) {
        console.error('Error cargando resultados:', error);
        document.getElementById('listaClasificacion').innerHTML = '<p>Error al cargar resultados.</p>';
      }
    }

    async function exportarResultados() {
      try {
        const resp = await fetch(`/api/sesion/${idSesion}/exportar_resultados`);
        if (!resp.ok) {
          let detalle = 'Error al exportar resultados';
          try {
            const err = await resp.json();
            if (err && err.error) detalle = err.error;
          } catch (_) {}
          throw new Error(detalle);
        }
        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `resultados_sesion_${idSesion}.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (e) {
        alert(`‚ùå No se pudieron exportar los resultados.\n${e.message || ''}`);
        console.error(e);
      }
    }

    window.addEventListener('beforeunload', () => {
      if (intervaloTemporizador) clearInterval(intervaloTemporizador);
      if (intervaloConsulta) clearTimeout(intervaloConsulta);
    });

    cargarSesionYPreguntas();
    consultarEstado();
  </script>
</body>

</html>