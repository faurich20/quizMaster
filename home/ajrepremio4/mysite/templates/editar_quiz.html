<!-- templates/editar_quiz.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editor de Preguntas - QuizPlatform</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa}
    .barra-navegacion{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .btn{background:#fff;color:#667eea;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700;text-decoration:none}
    .contenedor{max-width:1000px;margin:0 auto;padding:24px}
    .info-quiz{background:#fff;border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .tarjeta-pregunta{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:12px}
    .encabezado-pregunta{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .num-pregunta{background:#667eea;color:#fff;padding:6px 10px;border-radius:14px;font-weight:700}
    .opciones{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .opcion{display:flex;align-items:center;gap:10px;border:2px solid #e0e0e0;border-radius:10px;padding:10px}
    .opcion.correcta{background:#f1f8f4;border-color:#4caf50}
    .letra{width:34px;height:34px;border-radius:50%;background:#667eea;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .opcion.correcta .letra{background:#4caf50}
    .vacio{background:#fff;border-radius:12px;text-align:center;padding:40px;color:#666}
    .boton-flotante{position:fixed;right:22px;bottom:22px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:30px;padding:12px 20px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(102,126,234,.35)}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1000}
    .modal.activo{display:flex}
    .contenido-modal{background:#fff;border-radius:14px;padding:24px;max-width:720px;width:92%;max-height:90vh;overflow:auto}
    .grupo-formulario{margin-bottom:12px}
    .grupo-formulario label{display:block;font-weight:700;margin-bottom:6px;color:#333}
    .grupo-formulario input,.grupo-formulario textarea{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:10px;font-family:inherit}
    .opcion-editar{display:flex;gap:10px;align-items:center;background:#f8f9fa;border-radius:10px;padding:10px;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="barra-navegacion">
    <h3>üìù Editor de Preguntas</h3>
    <a href="/panel_control" class="btn">‚Üê Panel de Control</a>
  </div>
  <div class="contenedor">
    <div class="info-quiz">
      <h2 id="tituloQuiz">Cargando...</h2>
      <p id="descripcionQuiz"></p>
    </div>
    <div id="contenedorPreguntas"></div>
    <button class="boton-flotante" onclick="abrirModalPregunta()">+ Agregar Pregunta</button>
  </div>

  <div class="modal" id="modalPregunta">
    <div class="contenido-modal">
      <h3 id="tituloModal">Nueva Pregunta</h3>
      <form id="formularioPregunta">
        <input type="hidden" id="idPregunta" />
        <div class="grupo-formulario">
          <label for="textoPregunta">Pregunta</label>
          <textarea id="textoPregunta" required placeholder="Escribe tu pregunta..."></textarea>
        </div>
        <div class="grupo-formulario">
          <label for="urlImagen">URL de Imagen (opcional)</label>
          <input id="urlImagen" type="url" placeholder="https://..." />
        </div>
        <div class="grupo-formulario">
          <label for="urlVideo">URL de Video (opcional)</label>
          <input id="urlVideo" type="url" placeholder="https://..." />
        </div>
        <div class="grupo-formulario">
          <label for="tiempoLimite">Tiempo l√≠mite (segundos)</label>
          <input id="tiempoLimite" type="number" min="10" max="120" value="30" />
        </div>
        <div style="margin:8px 0 10px 0; color:#666; font-weight:700">Opciones (marca la correcta ‚úì)</div>
        <div class="opcion-editar"><div class="letra">A</div><input id="opcion1" placeholder="Opci√≥n A" required /><label><input type="checkbox" name="correcta" value="0" onchange="seleccionarCorrecta(0)"> Correcta</label></div>
        <div class="opcion-editar"><div class="letra">B</div><input id="opcion2" placeholder="Opci√≥n B" required /><label><input type="checkbox" name="correcta" value="1" onchange="seleccionarCorrecta(1)"> Correcta</label></div>
        <div class="opcion-editar"><div class="letra">C</div><input id="opcion3" placeholder="Opci√≥n C" required /><label><input type="checkbox" name="correcta" value="2" onchange="seleccionarCorrecta(2)"> Correcta</label></div>
        <div class="opcion-editar"><div class="letra">D</div><input id="opcion4" placeholder="Opci√≥n D" required /><label><input type="checkbox" name="correcta" value="3" onchange="seleccionarCorrecta(3)"> Correcta</label></div>
        <button class="btn" type="submit" style="width:100%;margin-top:8px">Guardar</button>
      </form>
    </div>
  </div>

  <script>
    const idQuiz = window.location.pathname.split('/').pop();
    let preguntas = [];
    let indiceCorrecta = -1;

    async function cargarQuiz(){
      try{ 
        const respuesta = await fetch(`/api/quizzes/${idQuiz}`); 
        const quiz = await respuesta.json();
        document.getElementById('tituloQuiz').textContent = quiz.titulo;
        document.getElementById('descripcionQuiz').textContent = quiz.descripcion || 'Sin descripci√≥n';
        preguntas = quiz.questions || []; 
        window.idPropietarioQuiz = quiz.id_profesor;
        renderizarPreguntas();
      }catch(e){ alert('Error cargando el quiz'); }
    }

    function renderizarPreguntas(){
      const contenedor = document.getElementById('contenedorPreguntas');
      if(!preguntas.length){ 
        contenedor.innerHTML = `<div class=\"vacio\"><div style=\"font-size:46px\">‚ùì</div><h3>No hay preguntas a√∫n</h3><p>Agrega tu primera pregunta</p></div>`; 
        return; 
      }
      const puedeEditar = (window.idPropietarioQuiz && window.idUsuarioActual && window.idPropietarioQuiz == window.idUsuarioActual);
      contenedor.innerHTML = preguntas.map((pregunta,indice)=>`
        <div class="tarjeta-pregunta">
          <div class="encabezado-pregunta">
            <div class="num-pregunta">Pregunta ${indice+1}</div>
            <div>
              ${puedeEditar ? `
              <button class="btn" onclick="abrirEdicion(${pregunta.id})">‚úèÔ∏è Editar</button>
              <button class="btn" style="background:#f44336;color:#fff" onclick="eliminarPregunta(${pregunta.id})">üóëÔ∏è Eliminar</button>` : ''}
            </div>
          </div>
          <div style="margin-bottom:8px;color:#333;font-weight:600">${pregunta.texto_pregunta}</div>
          ${pregunta.url_imagen?`<img src="${pregunta.url_imagen}" alt="img" style="max-width:280px;border-radius:10px;margin:6px 0">`:''}
          ${pregunta.url_video?`<div style="color:#667">üìπ <a href="${pregunta.url_video}" target="_blank">Ver video</a></div>`:''}
          <div style="color:#666;margin:8px 0">‚è±Ô∏è ${pregunta.tiempo_limite} s</div>
          <div class="opciones">
            ${pregunta.opciones.map((opcion,idx)=>`<div class="opcion ${opcion.es_correcta?'correcta':''}"><div class="letra">${String.fromCharCode(65+idx)}</div><div>${opcion.texto_opcion}</div></div>`).join('')}
          </div>
        </div>`).join('');
      // Mostrar/Ocultar bot√≥n de agregar pregunta
      const botonFlotante = document.querySelector('.boton-flotante');
      if (botonFlotante) botonFlotante.style.display = puedeEditar ? 'inline-block' : 'none';
    }

    function seleccionarCorrecta(indice){ 
      document.querySelectorAll('input[name="correcta"]').forEach((elemento,idx)=>{ 
        if(idx!==indice) elemento.checked=false; 
      }); 
      indiceCorrecta = indice; 
    }

    function abrirModalPregunta(){ 
      document.getElementById('tituloModal').textContent='Nueva Pregunta'; 
      document.getElementById('formularioPregunta').reset(); 
      document.getElementById('idPregunta').value=''; 
      indiceCorrecta=-1; 
      document.querySelectorAll('input[name="correcta"]').forEach(elemento=>elemento.checked=false); 
      alternarModal(true); 
    }

    function abrirEdicion(id){ 
      const pregunta = preguntas.find(x=>x.id===id); 
      if(!pregunta) return; 
      document.getElementById('tituloModal').textContent='Editar Pregunta'; 
      document.getElementById('idPregunta').value=pregunta.id; 
      document.getElementById('textoPregunta').value=pregunta.texto_pregunta; 
      document.getElementById('urlImagen').value=pregunta.url_imagen||''; 
      document.getElementById('urlVideo').value=pregunta.url_video||''; 
      document.getElementById('tiempoLimite').value=pregunta.tiempo_limite; 
      pregunta.opciones.forEach((opcion,idx)=>{ 
        document.getElementById('opcion'+(idx+1)).value=opcion.texto_opcion; 
        const casilla=document.querySelector(`input[name="correcta"][value="${idx}"]`); 
        casilla.checked=!!opcion.es_correcta; 
        if(opcion.es_correcta) indiceCorrecta=idx; 
      }); 
      alternarModal(true); 
    }

    function alternarModal(visible){ 
      document.getElementById('modalPregunta').classList.toggle('activo', !!visible); 
    }

    async function eliminarPregunta(id){ 
      if(!confirm('¬øEliminar pregunta?')) return; 
      try{ 
        const respuesta=await fetch(`/api/questions/${id}`,{method:'DELETE'}); 
        if(respuesta.ok){ 
          alert('‚úÖ Pregunta eliminada'); 
          cargarQuiz(); 
        } else alert('‚ùå Error eliminando'); 
      }catch(e){ alert('Error de conexi√≥n'); }
    }

    document.getElementById('formularioPregunta').addEventListener('submit', async (e)=>{
      e.preventDefault(); 
      if(indiceCorrecta===-1){ alert('Selecciona una respuesta correcta'); return; }
      const idPreg = document.getElementById('idPregunta').value;
      const datos = {
        texto_pregunta: document.getElementById('textoPregunta').value,
        url_imagen: document.getElementById('urlImagen').value,
        url_video: document.getElementById('urlVideo').value,
        tiempo_limite: parseInt(document.getElementById('tiempoLimite').value||'30'),
        posicion: preguntas.length,
        opciones: [0,1,2,3].map(i=>({ 
          text: document.getElementById('opcion'+(i+1)).value, 
          es_correcta: indiceCorrecta===i 
        }))
      };
      try{
        const url = idPreg? `/api/questions/${idPreg}` : `/api/quizzes/${idQuiz}/questions`;
        const metodo = idPreg? 'PUT' : 'POST';
        const respuesta = await fetch(url,{
          method: metodo, 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify(datos)
        });
        if(respuesta.ok){ 
          alert('‚úÖ Guardado'); 
          alternarModal(false); 
          cargarQuiz(); 
        } else { 
          alert('‚ùå Error guardando'); 
        }
      }catch(e){ alert('Error de conexi√≥n'); }
    });

    // Cargar sesi√≥n para conocer idUsuarioActual
    fetch('/api/informacion_sesion').then(respuesta=>respuesta.json()).then(datos=>{ 
      window.idUsuarioActual = datos.id_usuario; 
      cargarQuiz(); 
    }).catch(()=> cargarQuiz());
    
    window.addEventListener('keydown', (e)=>{ 
      if(e.key==='Escape') alternarModal(false); 
    });
  </script>
</body>
</html>