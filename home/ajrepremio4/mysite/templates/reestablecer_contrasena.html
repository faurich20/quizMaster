<!-- templates/reestablecer_contrasena.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restablecer Contrase√±a - QuizPlatform</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .contenedor { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 100%; padding: 40px; }
    .encabezado { text-align: center; margin-bottom: 30px; }
    .encabezado h1 { color: #333; font-size: 2em; margin-bottom: 10px; }
    .encabezado p { color: #666; }
    .grupo-formulario { margin-bottom: 20px; }
    .grupo-formulario label { display: block; color: #333; font-weight: bold; margin-bottom: 8px; }
    .grupo-formulario input { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: border-color 0.3s ease; }
    .grupo-formulario input:focus { outline: none; border-color: #667eea; }
    .requisitos-contrasena { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 10px; font-size: 0.85em; }
    .requisitos-contrasena h4 { color: #333; margin-bottom: 10px; }
    .requisito { color: #999; margin: 5px 0; display: flex; align-items: center; }
    .requisito.cumplido { color: #4caf50; }
    .requisito::before { content: "‚úó"; margin-right: 8px; font-weight: bold; }
    .requisito.cumplido::before { content: "‚úì"; }
    .btn { width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px; font-size: 1.05em; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .alerta { padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none; }
    .alerta.mostrar { display: block; }
    .alerta-exito { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alerta-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="encabezado">
      <h1>üîë Nueva Contrase√±a</h1>
      <p>Ingresa tu nueva contrase√±a</p>
    </div>

    <div class="alerta alerta-exito" id="alertaExito"></div>
    <div class="alerta alerta-error" id="alertaError"></div>

    <form id="formularioRestablecerContrasena">
      <div class="grupo-formulario">
        <label for="contrasena">Nueva Contrase√±a:</label>
        <input type="password" id="contrasena" name="contrasena" required autofocus />
        <div class="requisitos-contrasena">
          <h4>Requisitos de contrase√±a:</h4>
          <div class="requisito" id="req-longitud">M√≠nimo 8 caracteres</div>
          <div class="requisito" id="req-mayuscula">Al menos una may√∫scula</div>
          <div class="requisito" id="req-minuscula">Al menos una min√∫scula</div>
          <div class="requisito" id="req-numero">Al menos un n√∫mero</div>
          <div class="requisito" id="req-especial">Al menos un car√°cter especial (!@#$%^&*)</div>
        </div>
      </div>
      <div class="grupo-formulario">
        <label for="confirmarContrasena">Confirmar Contrase√±a:</label>
        <input type="password" id="confirmarContrasena" name="confirmarContrasena" required />
      </div>
      <button type="submit" class="btn" id="btnEnviar">Restablecer Contrase√±a</button>
    </form>
  </div>

  <script>
    const token = "{{ token }}";
    
    document.getElementById('contrasena').addEventListener('input', function(e) { 
      const contrasena = e.target.value; 
      alternar('req-longitud', contrasena.length >= 8); 
      alternar('req-mayuscula', /[A-Z]/.test(contrasena)); 
      alternar('req-minuscula', /[a-z]/.test(contrasena)); 
      alternar('req-numero', /[0-9]/.test(contrasena)); 
      alternar('req-especial', /[!@#$%^&*(),.?":{}|<>]/.test(contrasena)); 
    });
    
    function alternar(id, cumple){ 
      document.getElementById(id).classList.toggle('cumplido', cumple); 
    }
    
    document.getElementById('formularioRestablecerContrasena').addEventListener('submit', async function(e){ 
      e.preventDefault(); 
      const contrasena = document.getElementById('contrasena').value; 
      const confirmarContrasena = document.getElementById('confirmarContrasena').value; 
      
      if(contrasena !== confirmarContrasena){ 
        mostrar('error','Las contrase√±as no coinciden'); 
        return; 
      } 
      
      const requisitos = [ 
        contrasena.length >= 8, 
        /[A-Z]/.test(contrasena), 
        /[a-z]/.test(contrasena), 
        /[0-9]/.test(contrasena), 
        /[!@#$%^&*(),.?":{}|<>]/.test(contrasena) 
      ]; 
      
      if(!requisitos.every(Boolean)){ 
        mostrar('error','La contrase√±a no cumple con todos los requisitos'); 
        return; 
      } 
      
      try {
        const respuesta = await fetch(`/restablecer_contrasena/${token}`, { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify({ contrasena }) 
        }); 
        const datos = await respuesta.json(); 
        if(respuesta.ok){ 
          mostrar('exito','‚úÖ Contrase√±a actualizada. Redirigiendo...'); 
          setTimeout(()=> location.href='/iniciar_sesion', 1500); 
        } else { 
          mostrar('error', datos.error || 'Error al actualizar'); 
        } 
      } catch(error){ 
        mostrar('error','Error de conexi√≥n'); 
      } 
    });
    
    function mostrar(tipo, mensaje){ 
      const elemento = tipo === 'error' ? document.getElementById('alertaError') : document.getElementById('alertaExito'); 
      elemento.textContent = mensaje; 
      elemento.classList.add('mostrar'); 
      setTimeout(()=> elemento.classList.remove('mostrar'), 5000); 
    }
  </script>
</body>
</html>